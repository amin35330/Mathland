--- backend/package.json ---
{
  "name": "riazi-land-backend",
  "version": "1.0.0",
  "description": "Backend API for Riazi Land",
  "main": "dist/index.js",
  "scripts": {
    "start": "node dist/index.js",
    "dev": "nodemon src/index.ts",
    "build": "tsc"
  },
  "dependencies": {
    "cors": "^2.8.5",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "firebase-admin": "^12.1.1"
  },
  "devDependencies": {
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/node": "^20.12.7",
    "nodemon": "^3.1.0",
    "ts-node": "^10.9.2",
    "typescript": "^5.4.5"
  }
}

--- backend/src/config/db.ts ---
import admin from 'firebase-admin';

const connectDB = () => {
  try {
    // جلوگیری از اتصال تکراری
    if (admin.apps.length) {
      return;
    }

    const key = process.env.FIREBASE_SERVICE_ACCOUNT_KEY;

    if (!key) {
      throw new Error('Missing FIREBASE_SERVICE_ACCOUNT_KEY in environment variables');
    }

    let serviceAccount: any;

    // تلاش برای رمزگشایی از حالت Base64
    try {
      // اول فرض می‌کنیم Base64 است و دیکود می‌کنیم
      const decodedBuffer = Buffer.from(key, 'base64').toString('utf-8');
      // اگر خروجی شبیه JSON بود، پارس می‌کنیم
      if (decodedBuffer.trim().startsWith('{')) {
        serviceAccount = JSON.parse(decodedBuffer);
      } else {
        // اگر دیکود شد اما JSON نبود، شاید خودِ رشته اصلی JSON بوده
        serviceAccount = JSON.parse(key);
      }
    } catch (error) {
      // اگر Base64 نبود، تلاش می‌کنیم مستقیم پارس کنیم
      try {
        serviceAccount = JSON.parse(key);
      } catch (jsonError) {
        throw new Error('Failed to parse FIREBASE key. Ensure it is valid JSON or Base64 encoded JSON.');
      }
    }

    // اصلاح فرمت کلید خصوصی (مشکل رایج در ورسل)
    if (serviceAccount.private_key) {
      serviceAccount.private_key = serviceAccount.private_key.replace(/\\n/g, '\n');
    }

    // بررسی نهایی فیلدهای ضروری
    if (!serviceAccount.project_id || !serviceAccount.client_email || !serviceAccount.private_key) {
      throw new Error('Missing essential fields (project_id, client_email, private_key) in the service account key.');
    }

    admin.initializeApp({
      credential: admin.credential.cert(serviceAccount),
    });

    console.log('[database]: Firebase Admin Initialized Successfully');

  } catch (error: any) {
    console.error('[database]: Firebase Connection Error:', error.message);
    // در محیط پروداکشن نباید پروسه را کامل بکشیم تا لاگ‌ها ثبت شوند
  }
};

export default connectDB;

--- backend/src/controllers/aiController.ts ---
import { Request, Response } from 'express';
import admin from 'firebase-admin';

// تابع کمکی برای دریافت دیتابیس
const getDb = () => admin.firestore();

export const solveProblem = async (req: Request, res: Response) => {
  try {
    const { prompt, image, mimeType } = req.body;

    // ۱. خواندن کلید API از متغیرهای محیطی سرور
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error("GEMINI_API_KEY is not defined on the server.");
      return res.status(500).json({ message: 'کلید API هوش مصنوعی روی سرور تنظیم نشده است.' });
    }

    // ۲. تعیین مدل بر اساس وجود عکس
    const model = image ? "gemini-pro-vision" : "gemini-pro";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

    // ۳. ساختاردهی بدنه درخواست برای گوگل
    const parts = [];

    // دستورالعمل سیستمی و سوال کاربر را با هم ترکیب می‌کنیم
    const fullPrompt = `
      شما یک معلم ریاضی به نام "ریاضی‌یار" هستید.
      ماموریت: حل مسائل ریاضی به زبان فارسی، به صورت مرحله به مرحله و بدون استفاده از فرمت لاتک ($).
      پاسخ نهایی را در خط آخر بنویسید.
      
      سوال کاربر: ${prompt || (image ? "این تصویر را تحلیل کن و مسئله ریاضی آن را حل کن." : "سوال من را حل کن.")}
    `;
    parts.push({ text: fullPrompt });

    if (image) {
      const cleanedBase64 = image.startsWith('data:') ? image.split(',')[1] : image;
      parts.push({
        inline_data: {
          mime_type: mimeType || 'image/jpeg',
          data: cleanedBase64
        }
      });
    }

    // --- اصلاح مهم: اضافه کردن "role": "user" ---
    const requestBody = {
      contents: [{ 
        role: "user", // این فیلد حیاتی بود که جا افتاده بود
        parts: parts 
      }],
    };

    // ۴. ارسال درخواست با fetch
    const apiResponse = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });

    const responseData = await apiResponse.json();

    // ۵. بررسی خطای احتمالی از طرف گوگل
    if (!apiResponse.ok || !responseData.candidates || responseData.candidates.length === 0) {
      console.error("Google API Error:", responseData);
      throw new Error(responseData?.error?.message || 'پاسخ نامعتبر از سرور گوگل دریافت شد.');
    }

    // ۶. استخراج و ارسال پاسخ
    const text = responseData.candidates[0].content.parts[0].text;
    res.status(200).json({ answer: text });

  } catch (error: any) {
    console.error("--- FATAL AI ERROR ---", error);
    res.status(500).json({ message: 'یک خطای پیش‌بینی نشده در سرور هوش مصنوعی رخ داد.', error: error.toString() });
  }
};

--- backend/src/controllers/bookController.ts ---
import { Request, Response } from 'express';
import admin from 'firebase-admin';

const getDb = () => admin.firestore();

// دریافت همه کتاب‌ها
export const getBooks = async (req: Request, res: Response) => {
  try {
    const snapshot = await getDb().collection('books').orderBy('createdAt', 'desc').get();
    const books = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    res.json(books);
  } catch (error: any) {
    console.error('Error in getBooks:', error);
    res.status(500).json({ message: 'خطا در دریافت کتاب‌ها', error: error.message });
  }
};

// همگام‌سازی کتاب‌ها (حذف همه و درج جدید)
export const syncBooks = async (req: Request, res: Response) => {
  try {
    const booksData = req.body;
    const batch = getDb().batch();
    
    // 1. حذف همه کتاب‌های قبلی
    const existingDocs = await getDb().collection('books').listDocuments();
    existingDocs.forEach(doc => batch.delete(doc));
    
    // 2. افزودن کتاب‌های جدید
    booksData.forEach((book: any) => {
      const docRef = getDb().collection('books').doc(); // ID خودکار
      // فیلد id را حذف می‌کنیم تا خود فایربیس بسازد یا اگر هست استفاده کند
      const { id, ...data } = book; 
      batch.set(docRef, { ...data, createdAt: new Date().toISOString() });
    });

    await batch.commit();
    
    // بازگرداندن لیست جدید
    const snapshot = await getDb().collection('books').get();
    const newBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    res.json(newBooks);
  } catch (error: any) {
    console.error('Error in syncBooks:', error);
    res.status(500).json({ message: 'خطا در ذخیره کتاب‌ها', error: error.message });
  }
};

--- backend/src/controllers/contentController.ts ---
import { Request, Response } from 'express';
import admin from 'firebase-admin';

const getDb = () => admin.firestore();

// تابع کمکی برای سینک کردن هر کالکشن
const syncCollection = async (collectionName: string, dataItems: any[]) => {
    const batch = getDb().batch();
    const existingDocs = await getDb().collection(collectionName).listDocuments();
    existingDocs.forEach(doc => batch.delete(doc));
    
    dataItems.forEach((item: any) => {
        const docRef = getDb().collection(collectionName).doc();
        const { id, ...docData } = item;
        batch.set(docRef, { ...docData, createdAt: new Date().toISOString() });
    });
    await batch.commit();
    
    const snapshot = await getDb().collection(collectionName).get();
    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
};

// --- Videos ---
export const getVideos = async (req: Request, res: Response) => {
  try {
    const snapshot = await getDb().collection('videos').get();
    const videos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    res.json(videos);
  } catch (error: any) {
    console.error('Error fetching videos:', error);
    res.status(500).json({ message: 'Error fetching videos', error: error.message });
  }
};

export const syncVideos = async (req: Request, res: Response) => {
  try {
    const result = await syncCollection('videos', req.body);
    res.json(result);
  } catch (error: any) {
    console.error('Error syncing videos:', error);
    res.status(500).json({ message: 'Error syncing videos', error: error.message });
  }
};

// --- Paradoxes ---
export const getParadoxes = async (req: Request, res: Response) => {
  try {
    const snapshot = await getDb().collection('paradoxes').get();
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    res.json(data);
  } catch (error: any) {
    console.error('Error fetching paradoxes:', error);
    res.status(500).json({ message: 'Error fetching paradoxes', error: error.message });
  }
};

export const syncParadoxes = async (req: Request, res: Response) => {
  try {
    const result = await syncCollection('paradoxes', req.body);
    res.json(result);
  } catch (error: any) {
    console.error('Error syncing paradoxes:', error);
    res.status(500).json({ message: 'Error syncing paradoxes', error: error.message });
  }
};

// --- Creators ---
export const getCreators = async (req: Request, res: Response) => {
  try {
    const snapshot = await getDb().collection('creators').get();
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    res.json(data);
  } catch (error: any) {
    console.error('Error fetching creators:', error);
    res.status(500).json({ message: 'Error fetching creators', error: error.message });
  }
};

export const syncCreators = async (req: Request, res: Response) => {
  try {
    const result = await syncCollection('creators', req.body);
    res.json(result);
  } catch (error: any) {
    console.error('Error syncing creators:', error);
    res.status(500).json({ message: 'Error syncing creators', error: error.message });
  }
};

--- backend/src/controllers/settingsController.ts ---
import { Request, Response } from 'express';
import admin from 'firebase-admin';

const getDb = () => admin.firestore();

export const getSettings = async (req: Request, res: Response) => {
  try {
    const snapshot = await getDb().collection('settings').limit(1).get();
    
    if (snapshot.empty) {
      // تنظیمات پیش‌فرض اگر نبود
      const defaultSettings = { appName: 'ریاضی‌یار', adminEmail: '' };
      await getDb().collection('settings').add(defaultSettings);
      return res.json(defaultSettings);
    }
    
    const settings = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
    res.json(settings);
  } catch (error: any) {
    console.error('Error in getSettings:', error);
    res.status(500).json({ message: 'خطا در دریافت تنظیمات', error: error.message });
  }
};

export const updateSettings = async (req: Request, res: Response) => {
  try {
    const newSettings = req.body;
    const snapshot = await getDb().collection('settings').limit(1).get();

    if (snapshot.empty) {
      await getDb().collection('settings').add(newSettings);
    } else {
      const docId = snapshot.docs[0].id;
      await getDb().collection('settings').doc(docId).update(newSettings);
    }
    
    res.json(newSettings);
  } catch (error: any) {
    console.error('Error in updateSettings:', error);
    res.status(500).json({ message: 'خطا در ذخیره تنظیمات', error: error.message });
  }
};

--- backend/src/controllers/teacherController.ts ---
import { Request, Response } from 'express';
import admin from 'firebase-admin';

const getDb = () => admin.firestore();

export const getTeachers = async (req: Request, res: Response) => {
  try {
    const snapshot = await getDb().collection('teachers').orderBy('createdAt', 'desc').get();
    const teachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    res.json(teachers);
  } catch (error: any) {
    console.error('Error in getTeachers:', error);
    res.status(500).json({ message: 'خطا در دریافت لیست معلمین', error: error.message });
  }
};

export const syncTeachers = async (req: Request, res: Response) => {
  try {
    const data = req.body;
    const batch = getDb().batch();
    
    const existingDocs = await getDb().collection('teachers').listDocuments();
    existingDocs.forEach(doc => batch.delete(doc));
    
    data.forEach((item: any) => {
      const docRef = getDb().collection('teachers').doc();
      const { id, ...docData } = item;
      batch.set(docRef, { ...docData, createdAt: new Date().toISOString() });
    });

    await batch.commit();
    
    const snapshot = await getDb().collection('teachers').get();
    const newItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    res.json(newItems);
  } catch (error: any) {
    console.error('Error in syncTeachers:', error);
    res.status(500).json({ message: 'خطا در ذخیره معلمین', error: error.message });
  }
};

--- backend/src/index.ts ---
import express, { Express, Request, Response } from 'express';
import dotenv from 'dotenv';
import cors from 'cors';
import connectDB from './config/db';
import apiRoutes from './routes/apiRoutes';

dotenv.config();

const app: Express = express();
connectDB();

// --- تنظیمات نهایی و قطعی CORS ---
const whitelist = ['https://mathland-frontend.vercel.app'];

const corsOptions: cors.CorsOptions = {
  origin: (origin, callback) => {
    // اگر مبدا درخواست در لیست سفید بود یا اصلا مبدایی وجود نداشت (مثل درخواست مستقیم)
    if (!origin || whitelist.indexOf(origin) !== -1) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
};

// مرحله ۱: برای تمام درخواست‌های امنیتی OPTIONS، سریعا پاسخ موفق بده
// این خط مهم‌ترین بخش برای حل مشکل است
app.options('*', cors(corsOptions));

// مرحله ۲: برای تمام درخواست‌های دیگر، از همان تنظیمات استفاده کن
app.use(cors(corsOptions));
// ------------------------------------

app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ limit: '50mb', extended: true }));

app.use('/api', apiRoutes);

app.get('/', (req: Request, res: Response) => {
  res.send('Riazi Land Backend is Running Correctly!');
});

module.exports = app;

--- backend/src/models/allModels.ts ---
// دیگر نیازی به mongoose نیست، فقط اینترفیس‌ها را تعریف می‌کنیم
// Firestore به صورت خودکار ID و timestamp را اضافه می‌کند

export interface Book {
  id?: string; // Firestore ID
  title: string;
  author: string;
  description: string;
  subject: string;
  imageUrl: string;
  downloadUrl: string;
  rating: number;
}

export interface Teacher {
  id?: string; // Firestore ID
  name: string;
  bio: string;
  experience: string;
  imageUrl: string;
  phone: string;
  email: string;
}

export interface Video {
  id?: string; // Firestore ID
  title: string;
  tutor: string;
  thumbnailUrl: string;
  duration: string;
  category: string;
  videoUrl?: string;
}

export interface Paradox {
  id?: string; // Firestore ID
  title: string;
  summary: string;
  content: string;
}

export interface Creator {
  id?: string; // Firestore ID
  name: string;
  role: string;
  bio: string;
  imageUrl: string;
}

export interface Settings {
  id?: string; // Firestore ID
  appName: string;
  appLogoUrl: string;
  adminEmail: string;
  eitaaLink: string;
  rubikaLink: string;
  address: string;
  phone: string;
  copyrightText: string;
  apiKey: string;
}

// برای Firestore نیازی به export کردن مدل‌های Mongoose نیست
// این فایل فقط برای تعریف Type ها استفاده می‌شود

--- backend/src/routes/apiRoutes.ts ---
import express from 'express';
import { getBooks, syncBooks } from '../controllers/bookController';
import { getTeachers, syncTeachers } from '../controllers/teacherController';
import { 
  getVideos, syncVideos, 
  getParadoxes, syncParadoxes, 
  getCreators, syncCreators 
} from '../controllers/contentController';
import { getSettings, updateSettings } from '../controllers/settingsController';
// --- اضافه شد ---
import { solveProblem } from '../controllers/aiController'; 

const router = express.Router();

router.get('/books', getBooks);
router.post('/books', syncBooks);

router.get('/teachers', getTeachers);
router.post('/teachers', syncTeachers);

router.get('/videos', getVideos);
router.post('/videos', syncVideos);

router.get('/paradoxes', getParadoxes);
router.post('/paradoxes', syncParadoxes);

router.get('/creators', getCreators);
router.post('/creators', syncCreators);

router.get('/settings', getSettings);
router.post('/settings', updateSettings);

// --- مسیر جدید ---
router.post('/ai/solve', solveProblem);

export default router;

--- backend/tsconfig.json ---
{
  "compilerOptions": {
    "target": "es2016",
    "module": "commonjs",
    "rootDir": "./src",
    "outDir": "./dist",
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "strict": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"]
}

--- backend/vercel.json ---
{
  "version": 2,
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/src/index.ts"
    }
  ],
  "headers": [
    {
      "source": "/api/(.*)",
      "headers": [
        { "key": "Access-Control-Allow-Credentials", "value": "true" },
        { "key": "Access-Control-Allow-Origin", "value": "https://mathland-frontend.vercel.app" },
        { "key": "Access-Control-Allow-Methods", "value": "GET,OPTIONS,PATCH,DELETE,POST,PUT" },
        { "key": "Access-Control-Allow-Headers", "value": "X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version" }
      ]
    }
  ]
}

--- frontend/constants.ts ---
import { Book, Paradox, Teacher, Video, Creator, Settings } from "./types";

export const INITIAL_SETTINGS: Settings = {
  appName: 'ریاضی‌یار',
  appLogoUrl: '', // Empty means use default icon
  adminEmail: 'admin@riaziyar.ir',
  eitaaLink: 'https://eitaa.com/',
  rubikaLink: 'https://rubika.ir/',
  address: 'تهران، میدان آزادی، دانشگاه شریف',
  phone: '021-66000000',
  copyrightText: '۱۴۰۴ ریاضی‌یار، تمامی حقوق سایت متعلق به ترانه سادات موسوی و فاطمه شیرعلی پور می‌باشد.',
  apiKey: ''
};

export const INITIAL_CREATORS: Creator[] = [
  {
    id: '1',
    name: 'ترانه سادات موسوی',
    role: 'پایه یازدهم',
    bio: 'علاقه‌مند به برنامه‌نویسی وب و هوش مصنوعی. طراح رابط کاربری پروژه.',
    imageUrl: 'https://picsum.photos/300/300?random=100'
  },
  {
    id: '2',
    name: 'فاطمه شیرعلی پور',
    role: 'پایه یازدهم',
    bio: 'توسعه‌دهنده فرانت‌اند و علاقه‌مند به ریاضیات گسسته. مدیر فنی پروژه.',
    imageUrl: 'https://picsum.photos/300/300?random=101'
  }
];

export const INITIAL_BOOKS: Book[] = [
  {
    id: '1',
    title: 'ریاضیات جامع نهم',
    author: 'دکتر علوی',
    description: 'کتاب کار و تمرین برای دانش‌آموزان سال نهم با پاسخ‌های تشریحی و نکات کلیدی.',
    subject: 'ریاضی نهم',
    imageUrl: 'https://picsum.photos/200/300?random=1',
    downloadUrl: '#',
    rating: 4.5,
  },
  {
    id: '2',
    title: 'هندسه به زبان ساده',
    author: 'مهندس حسینی',
    description: 'آموزش گام به گام هندسه اقلیدسی برای دوره اول متوسطه همراه با شکل‌های رنگی.',
    subject: 'هندسه',
    imageUrl: 'https://picsum.photos/200/300?random=2',
    downloadUrl: '#',
    rating: 4.8,
  },
  {
    id: '3',
    title: 'جادوی جبر',
    author: 'خانم اکبری',
    description: 'تکنیک‌های حل سریع معادلات جبری و نامعادلات برای آمادگی در آزمون‌ها.',
    subject: 'جبر و معادلات',
    imageUrl: 'https://picsum.photos/200/300?random=3',
    downloadUrl: '#',
    rating: 4.2,
  }
];

export const INITIAL_TEACHERS: Teacher[] = [
  {
    id: '1',
    name: 'استاد محمدی',
    bio: 'عاشق تدریس ریاضی با روش‌های خلاقانه و مفهومی. هدف من ساده‌سازی پیچیده‌ترین مسائل برای دانش‌آموزان است.',
    experience: '۱۲ سال تدریس در مدارس نمونه دولتی و تیزهوشان',
    imageUrl: 'https://picsum.photos/300/400?random=4',
    phone: '09123456789',
    email: 'mohammadi@example.com'
  },
  {
    id: '2',
    name: 'خانم رضایی',
    bio: 'متخصص هندسه و آموزش تصویری. باور دارم که ریاضیات هنر دیدن الگوهاست.',
    experience: '۸ سال سابقه آموزش آنلاین و حضوری',
    imageUrl: 'https://picsum.photos/300/400?random=5',
    phone: '09987654321',
    email: 'rezaei@example.com'
  },
  {
    id: '3',
    name: 'دکتر کمالی',
    bio: 'دکترای ریاضی محض و مدرس المپیاد. آماده‌سازی دانش‌آموزان برای مسابقات جهانی.',
    experience: '۱۵ سال تدریس دانشگاهی و المپیاد',
    imageUrl: 'https://picsum.photos/300/400?random=6',
    phone: '02188888888',
    email: 'kamali@example.com'
  }
];

export const INITIAL_VIDEOS: Video[] = [
  {
    id: '1',
    title: 'آموزش معادله خط',
    tutor: 'استاد محمدی',
    thumbnailUrl: 'https://picsum.photos/300/180?random=6',
    duration: '۱۵:۳۰',
    category: 'نهم',
    videoUrl: '<iframe src="https://www.aparat.com/video/video/embed/videohash/IyQn8/vt/frame" title="آموزش ریاضی نهم - فصل ششم - معادله خط" allowFullScreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>',
  },
  {
    id: '2',
    title: 'فیثاغورس در ۵ دقیقه',
    tutor: 'خانم رضایی',
    thumbnailUrl: 'https://picsum.photos/300/180?random=7',
    duration: '۰۵:۰۰',
    category: 'هشتم',
    videoUrl: '<iframe src="https://www.aparat.com/video/video/embed/videohash/AmZ4k/vt/frame" title="ریاضی هشتم فصل ششم درس اول رابطه فیثاغورس" allowFullScreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>',
  },
  {
    id: '3',
    title: 'اعداد اول و مرکب',
    tutor: 'استاد محمدی',
    thumbnailUrl: 'https://picsum.photos/300/180?random=8',
    duration: '۱۰:۴۵',
    category: 'هفتم',
    videoUrl: '<iframe src="https://www.aparat.com/video/video/embed/videohash/uK5Uv/vt/frame" title="ریاضی هفتم فصل پنجم درس اول عدد اول" allowFullScreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>',
  }
];

export const INITIAL_PARADOXES: Paradox[] = [
  {
    id: '1',
    title: 'پارادوکس زنون',
    summary: 'آیا آشیل هرگز به لاک‌پشت می‌رسد؟',
    content: 'در این پارادوکس، زنون استدلال می‌کند که حرکت غیرممکن است زیرا برای رسیدن به هر نقطه‌ای، باید نیمی از راه را طی کنید، و قبل از آن نیمی از نیمه راه را... \n\nشرح کامل: فرض کنید آشیل که سریع‌ترین دونده است، بخواهد با لاک‌پشتی مسابقه دهد و به او ۱۰ متر آوانس بدهد. وقتی آشیل ۱۰ متر را طی می‌کند، لاک‌پشت کمی جلوتر رفته (مثلا ۱ متر). وقتی آشیل آن ۱ متر را طی می‌کند، لاک‌پشت باز هم کمی جلوتر رفته است (۱۰ سانتی‌متر). این روند تا بی‌نهایت ادامه دارد و به نظر می‌رسد آشیل هرگز به لاک‌پشت نمی‌رسد! راه حل ریاضی این مسئله با استفاده از مفهوم "حد" و "سری‌های همگرا" در ریاضیات حل می‌شود.'
  },
  {
    id: '2',
    title: 'هتل بی‌نهایت هیلبرت',
    summary: 'چگونه یک هتل پر می‌تواند مهمان جدید بپذیرد؟',
    content: 'تصور کنید هتلی با تعداد اتاق‌های بی‌نهایت دارید که تمام اتاق‌های آن پر است. اگر یک مهمان جدید بیاید، آیا می‌توانید به او اتاق بدهید؟ \n\nبله! کافیست مدیر هتل از مهمان اتاق ۱ بخواهد به اتاق ۲ برود، مهمان اتاق ۲ به ۳، و به طور کلی مهمان اتاق n به n+1 برود. حالا اتاق ۱ خالی می‌شود و مهمان جدید می‌تواند در آن ساکن شود. این نشان‌دهنده ویژگی‌های عجیب مجموعه‌های بی‌نهایت است.'
  },
  {
    id: '3',
    title: 'مسأله مونتی هال',
    summary: 'سه درب، یک جایزه. آیا درب خود را عوض می‌کنید؟',
    content: 'شما در یک مسابقه هستید. سه درب وجود دارد. پشت یکی ماشین و پشت دوتای دیگر بز است. شما یک درب را انتخاب می‌کنید (مثلا درب ۱). مجری که می‌داند پشت درب‌ها چیست، یکی از درب‌های پوچ دیگر را باز می‌کند (مثلا درب ۳ که بز دارد). حال به شما پیشنهاد می‌کند انتخابتان را به درب ۲ تغییر دهید. آیا باید عوض کنید؟ \n\nپاسخ ریاضی: بله! اگر تغییر ندهید شانس شما ۱/۳ است، اما اگر تغییر دهید شانس برنده شدن شما به ۲/۳ افزایش می‌یابد.'
  }
];

--- frontend/index.html ---
<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ریاضی‌یار | دستیار هوشمند ریاضی</title>
    
    <!-- فونت وزیر متن از گوگل فونت -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">
  </head>
  <body>
    <div id="root"></div>
    <!-- اصلاح مهم: آدرس فایل اصلی به داخل پوشه src اشاره می‌کند -->
    <script type="module" src="/src/index.tsx"></script>
  </body>
</html>

--- frontend/metadata.json ---
{
  "name": "ریاضی لند کامل",
  "description": "A modern, Persian-language educational platform for middle-school math students featuring AI-powered problem solving, video lessons, and teacher resources.",
  "requestFramePermissions": [
    "camera",
    "microphone"
  ]
}

--- frontend/package.json ---
{
  "name": "riazi-land-frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "lint": "eslint .",
    "preview": "vite preview"
  },
  "dependencies": {
    "lucide-react": "^0.344.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.22.3"
  },
  "devDependencies": {
    "@types/react": "^18.2.66",
    "@types/react-dom": "^18.2.22",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.19",
    "eslint": "^8.57.0",
    "eslint-plugin-react": "^7.34.1",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.6",
    "postcss": "^8.4.38",
    "tailwindcss": "^3.4.3",
    "typescript": "^5.2.2",
    "vite": "^5.2.0"
  }
}

--- frontend/postcss.config.js ---
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}

--- frontend/README.md ---
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1YMt3LbrSC_Jc4oCwDoVffjiuth5H6HIc

## Run Locally

**Prerequisites:**  Node.js

1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`

--- frontend/src/App.tsx ---
import React from 'react';
import { HashRouter as Router, Routes, Route } from 'react-router-dom';
import { AppProvider, useAppContext } from './AppContext';
import { Navbar } from './components/Navbar';
import { AnimatedBackground } from './components/AnimatedBackground';
import { Home } from './pages/Home';
import { Books } from './pages/Books';
import { Teachers } from './pages/Teachers';
import { Videos } from './pages/Videos';
import { Paradox } from './pages/Paradox';
import { About } from './pages/About';
import { Admin } from './pages/Admin';

const Layout: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { settings } = useAppContext();
  return (
    <div className="min-h-screen bg-[#f5f3ff] dark:bg-[#0f172a] transition-colors duration-300 text-gray-800 dark:text-gray-200 font-sans flex flex-col relative overflow-hidden">
      <AnimatedBackground />
      <Navbar />
      <main className="flex-grow pb-20 relative z-10">
        {children}
      </main>
      <footer className="bg-white/60 dark:bg-gray-900/60 backdrop-blur-md border-t border-white/20 dark:border-gray-800 py-8 text-center text-sm text-gray-500 relative z-10">
        <p className="font-medium">
          {settings.copyrightText}
        </p>
      </footer>
    </div>
  );
};

export default function App() {
  return (
    <AppProvider>
      <Router>
        <Routes>
          <Route path="/admin" element={<Admin />} />
          <Route path="*" element={
            <Layout>
              <Routes>
                <Route path="/" element={<Home />} />
                <Route path="/books" element={<Books />} />
                <Route path="/teachers" element={<Teachers />} />
                <Route path="/videos" element={<Videos />} />
                <Route path="/paradox" element={<Paradox />} />
                <Route path="/about" element={<About />} />
              </Routes>
            </Layout>
          } />
        </Routes>
      </Router>
    </AppProvider>
  );
}

--- frontend/src/AppContext.tsx ---
import React, { createContext, useContext, useState, useEffect } from 'react';
import { AppContextType, Book, Teacher, Video, Paradox, ThemeSettings, Creator, Settings } from './types';
import { api } from './services/api';

// تنظیمات پیش‌فرض (تا زمانی که از سرور لود شود)
const DEFAULT_SETTINGS: Settings = {
  appName: 'ریاضی‌یار',
  appLogoUrl: '',
  adminEmail: '',
  eitaaLink: '',
  rubikaLink: '',
  address: '',
  phone: '',
  copyrightText: '',
  apiKey: ''
};

const AppContext = createContext<AppContextType | undefined>(undefined);

export const AppProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [books, setBooks] = useState<Book[]>([]);
  const [teachers, setTeachers] = useState<Teacher[]>([]);
  const [videos, setVideos] = useState<Video[]>([]);
  const [paradoxes, setParadoxes] = useState<Paradox[]>([]);
  const [creators, setCreators] = useState<Creator[]>([]);
  const [settings, setSettings] = useState<Settings>(DEFAULT_SETTINGS);
  
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  
  const [theme, setTheme] = useState<ThemeSettings>({
    darkMode: false,
    primaryColor: 'teal',
  });

  // 1. بارگذاری تم از حافظه مرورگر
  useEffect(() => {
    const savedTheme = localStorage.getItem('theme_preference');
    if (savedTheme === 'dark') {
      setTheme(prev => ({ ...prev, darkMode: true }));
      document.documentElement.classList.add('dark');
    }
  }, []);

  // 2. دریافت تمام اطلاعات از سرور هنگام باز شدن سایت
  useEffect(() => {
    const fetchData = async () => {
      try {
        setIsLoading(true);
        const [booksData, teachersData, videosData, paradoxesData, creatorsData, settingsData] = await Promise.all([
          api.getBooks(),
          api.getTeachers(),
          api.getVideos(),
          api.getParadoxes(),
          api.getCreators(),
          api.getSettings()
        ]);

        if (booksData) setBooks(booksData);
        if (teachersData) setTeachers(teachersData);
        if (videosData) setVideos(videosData);
        if (paradoxesData) setParadoxes(paradoxesData);
        if (creatorsData) setCreators(creatorsData);
        
        // اگر تنظیمات از سرور آمد، جایگزین کن
        if (settingsData && settingsData.appName) {
            setSettings(settingsData);
        }
        
      } catch (error) {
        console.error("Error loading initial data:", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchData();
  }, []);

  const login = () => setIsAuthenticated(true);
  const logout = () => setIsAuthenticated(false);

  const toggleTheme = () => {
    setTheme(prev => {
      const newMode = !prev.darkMode;
      if (newMode) {
        document.documentElement.classList.add('dark');
        localStorage.setItem('theme_preference', 'dark');
      } else {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('theme_preference', 'light');
      }
      return { ...prev, darkMode: newMode };
    });
  };

  // تابع آپدیت داده‌ها (هم در صفحه و هم در سرور)
  const updateData = async (type: 'books' | 'teachers' | 'videos' | 'paradoxes' | 'creators', data: any[]) => {
    try {
      // اول State را آپدیت می‌کنیم تا کاربر تغییر را سریع ببیند
      switch (type) {
        case 'books': setBooks(data); await api.saveBooks(data); break;
        case 'teachers': setTeachers(data); await api.saveTeachers(data); break;
        case 'videos': setVideos(data); await api.saveVideos(data); break;
        case 'paradoxes': setParadoxes(data); await api.saveParadoxes(data); break;
        case 'creators': setCreators(data); await api.saveCreators(data); break;
      }
    } catch (error) {
      console.error(`Failed to save ${type}:`, error);
      alert('خطا در ذخیره اطلاعات در سرور.');
    }
  };

  // تابع اختصاصی آپدیت تنظیمات
  const updateSettings = async (newSettings: Settings) => {
    try {
      setSettings(newSettings);
      await api.saveSettings(newSettings);
    } catch (error) {
      console.error('Failed to save settings:', error);
      throw error; // خطا را به کامپوننت Admin می‌فرستیم تا آلرت دهد
    }
  };

  if (isLoading) {
    return (
      <div className="fixed inset-0 flex items-center justify-center bg-gray-50 dark:bg-gray-900 z-50" dir="rtl">
        <div className="flex flex-col items-center gap-4">
          <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
          <p className="text-gray-600 dark:text-gray-300 font-bold">در حال دریافت اطلاعات...</p>
        </div>
      </div>
    );
  }

  return (
    <AppContext.Provider value={{
      books, teachers, videos, paradoxes, creators, settings, theme, isAuthenticated,
      login, logout, toggleTheme, updateData, updateSettings
    }}>
      {children}
    </AppContext.Provider>
  );
};

export const useAppContext = () => {
  const context = useContext(AppContext);
  if (!context) {
    throw new Error("useAppContext must be used within an AppProvider");
  }
  return context;
};

--- frontend/src/components/AnimatedBackground.tsx ---
import React from 'react';
import { Sparkles } from 'lucide-react';

export const AnimatedBackground: React.FC = () => {
  return (
    <div className="fixed inset-0 pointer-events-none overflow-hidden z-0">
        <div className="absolute top-[-10%] left-[-10%] w-[50vw] h-[50vw] bg-primary-400/20 dark:bg-primary-900/20 rounded-full blur-[100px] animate-wander-1 mix-blend-multiply dark:mix-blend-screen"></div>
        <div className="absolute top-[20%] right-[-5%] w-[45vw] h-[45vw] bg-accent-400/20 dark:bg-accent-900/20 rounded-full blur-[90px] animate-wander-2 mix-blend-multiply dark:mix-blend-screen"></div>
        <div className="absolute bottom-[-10%] left-[20%] w-[40vw] h-[40vw] bg-blue-400/20 dark:bg-blue-900/20 rounded-full blur-[100px] animate-wander-3 mix-blend-multiply dark:mix-blend-screen"></div>
        <div className="absolute top-1/4 left-1/4 w-6 h-6 bg-white rounded-full blur-[4px] shadow-[0_0_30px_15px_rgba(255,255,255,0.4)] animate-pulse"></div>
        <div className="absolute bottom-1/3 right-1/3 w-4 h-4 bg-accent-300 rounded-full blur-[2px] shadow-[0_0_20px_10px_rgba(236,72,153,0.6)] animate-float delay-75"></div>
        <div className="absolute top-1/2 right-1/4 w-3 h-3 bg-primary-300 rounded-full blur-[2px] shadow-[0_0_25px_8px_rgba(139,92,246,0.5)] animate-pulse delay-150"></div>
        <div className="absolute bottom-1/4 left-1/3 w-5 h-5 bg-blue-300 rounded-full blur-[3px] shadow-[0_0_20px_10px_rgba(59,130,246,0.5)] animate-float delay-300"></div>
        <div className="absolute top-[15%] right-[20%] opacity-60 animate-pulse-glow delay-200"><Sparkles size={24} className="text-yellow-200" /></div>
        <div className="absolute top-[60%] left-[10%] opacity-40 animate-pulse-glow delay-500"><Sparkles size={18} className="text-primary-200" /></div>
        <div className="absolute bottom-[20%] right-[15%] opacity-50 animate-pulse-glow delay-1000"><Sparkles size={30} className="text-accent-200" /></div>
        <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCI+CjxwYXRoIGQ9Ik0zMCAzMEwzMSAzMEwzMSAzMUwzMCAzMUwzMCAzMHoiIGZpbGw9InJnYmEoMjAwLDIwMCwyNTUsMC4wNSkiLz4KPC9zdmc+')] opacity-30"></div>
    </div>
  );
};

--- frontend/src/components/Navbar.tsx ---
import React, { useState } from 'react';
import { Link, useLocation } from 'react-router-dom';
import { Menu, X, Sun, Moon, GraduationCap, ShieldCheck } from 'lucide-react';
import { useAppContext } from '../AppContext';

export const Navbar: React.FC = () => {
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const { theme, toggleTheme, isAuthenticated, settings } = useAppContext();
  const location = useLocation();

  const navLinks = [
    { to: '/', label: 'خانه' },
    { to: '/books', label: 'کتاب‌ها' },
    { to: '/teachers', label: 'معلمین' },
    { to: '/videos', label: 'ویدیوها' },
    { to: '/paradox', label: 'عجایب ریاضی' },
    { to: '/about', label: 'درباره ما' },
  ];

  const isActive = (path: string) => location.pathname === path;

  return (
    <nav className="sticky top-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md border-b border-gray-200/50 dark:border-gray-800/50 shadow-sm transition-colors duration-300">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex items-center justify-between h-16">
          
          {/* Logo Section */}
          <div className="flex items-center gap-2">
            <Link to="/admin" className="flex items-center gap-2 group" title="ورود به پنل مدیریت">
              <div className="bg-gradient-to-br from-primary-500 to-accent-500 p-2 rounded-lg text-white transform group-hover:rotate-12 transition-transform shadow-lg shadow-primary-500/30 relative overflow-hidden">
                {settings.appLogoUrl ? (
                  <img src={settings.appLogoUrl} alt="Logo" className="w-6 h-6 object-cover" />
                ) : (
                  <GraduationCap size={24} />
                )}
              </div>
              <span className="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-l from-primary-600 to-accent-500 dark:from-primary-400 dark:to-accent-300">
                {settings.appName}
              </span>
            </Link>
          </div>

          {/* Desktop Nav */}
          <div className="hidden md:flex items-center space-x-1 space-x-reverse">
            {navLinks.map((link) => (
              <Link
                key={link.to}
                to={link.to}
                className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${
                  isActive(link.to)
                    ? 'text-primary-600 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/30'
                    : 'text-gray-600 dark:text-gray-300 hover:text-primary-500 dark:hover:text-primary-300 hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
              >
                {link.label}
              </Link>
            ))}
            
            {isAuthenticated && (
              <Link to="/admin" className="mr-2 text-accent-600 dark:text-accent-400 hover:text-accent-700 font-bold text-sm flex items-center gap-1 px-3 py-2 bg-accent-50 dark:bg-accent-900/20 rounded-lg">
                <ShieldCheck size={16} />
                <span>پنل مدیریت</span>
              </Link>
            )}
          </div>

          {/* Right Actions */}
          <div className="flex items-center gap-4">
            <button
              onClick={toggleTheme}
              className="p-2 rounded-full text-gray-500 hover:text-primary-600 dark:text-gray-400 dark:hover:text-primary-300 transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 bg-gray-100 dark:bg-gray-800"
              aria-label="Toggle Theme"
            >
              {theme.darkMode ? <Sun size={20} /> : <Moon size={20} />}
            </button>
            
            <div className="md:hidden">
              <button
                onClick={() => setIsMenuOpen(!isMenuOpen)}
                className="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800"
              >
                {isMenuOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Mobile Menu */}
      {isMenuOpen && (
        <div className="md:hidden bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800">
          <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
            {navLinks.map((link) => (
              <Link
                key={link.to}
                to={link.to}
                onClick={() => setIsMenuOpen(false)}
                className={`block px-3 py-2 rounded-md text-base font-medium ${
                  isActive(link.to)
                    ? 'text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-gray-800'
                    : 'text-gray-600 dark:text-gray-300 hover:text-primary-500 hover:bg-gray-50 dark:hover:bg-gray-800'
                }`}
              >
                {link.label}
              </Link>
            ))}
            {isAuthenticated && (
              <Link
                to="/admin"
                onClick={() => setIsMenuOpen(false)}
                className="block px-3 py-2 rounded-md text-base font-medium text-accent-600 dark:text-accent-400 bg-accent-50 dark:bg-gray-800"
              >
                پنل مدیریت
              </Link>
            )}
          </div>
        </div>
      )}
    </nav>
  );
};

--- frontend/src/index.css ---
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  html {
    scroll-behavior: smooth;
  }
  
  body {
    @apply bg-gray-50 text-gray-900 font-sans antialiased;
    font-family: 'Vazirmatn', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  .dark body {
    @apply bg-slate-900 text-gray-200;
  }
}

/* Custom Scrollbar Styles */
::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  @apply bg-primary-300 rounded-lg hover:bg-primary-500;
}
.dark ::-webkit-scrollbar-thumb {
  @apply bg-primary-800 hover:bg-primary-700;
}

--- frontend/src/index.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css'; // این خط حیاتی است و باید اول باشد
import App from './App';

const rootElement = document.getElementById('root');

if (!rootElement) {
  throw new Error('Failed to find the root element to mount the app');
}

const root = ReactDOM.createRoot(rootElement);

root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
);

--- frontend/src/pages/About.tsx ---
import React from 'react';
import { Mail, Phone, MapPin, Send, GraduationCap } from 'lucide-react';
import { useAppContext } from '../AppContext';

// Custom Icons for Eitaa and Rubika since they are not in Lucide
const EitaaIcon = () => (
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="24" height="24" rx="12" fill="#E37227"/>
    <path d="M16.5 7.5H7.5C6.67157 7.5 6 8.17157 6 9V15C6 15.8284 6.67157 16.5 7.5 16.5H16.5C17.3284 16.5 18 15.8284 18 15V9C18 8.17157 17.3284 7.5 16.5 7.5Z" fill="white"/>
    <path d="M12 13.5L9 10.5M12 13.5L15 10.5M12 13.5V7.5" stroke="#E37227" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"/>
  </svg>
);

const RubikaIcon = () => (
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <rect width="24" height="24" rx="12" fill="#702D87"/>
    <path d="M12 6L17 10.5V16.5L12 19.5L7 16.5V10.5L12 6Z" fill="white"/>
  </svg>
);

export const About: React.FC = () => {
  const { creators, settings } = useAppContext();

  return (
    <div className="max-w-7xl mx-auto px-4 py-12">
      
      {/* Hero Section */}
      <div className="bg-white dark:bg-gray-800 rounded-3xl shadow-lg p-8 md:p-12 text-center mb-16 relative overflow-hidden">
        <div className="absolute top-0 right-0 w-32 h-32 bg-primary-100 dark:bg-primary-900/20 rounded-bl-[100px] -z-0"></div>
        <div className="absolute bottom-0 left-0 w-24 h-24 bg-accent-100 dark:bg-accent-900/20 rounded-tr-[80px] -z-0"></div>
        
        <div className="relative z-10">
            <div className="flex justify-center mb-6">
                <div className="p-4 bg-gradient-to-br from-primary-100 to-accent-100 dark:from-gray-700 dark:to-gray-600 rounded-full shadow-inner">
                    {settings.appLogoUrl ? (
                        <img src={settings.appLogoUrl} alt="Logo" className="w-16 h-16 object-contain" />
                    ) : (
                         <GraduationCap size={64} className="text-primary-600 dark:text-primary-400" />
                    )}
                </div>
            </div>
            <h1 className="text-4xl md:text-5xl font-black text-gray-900 dark:text-white mb-6">
              درباره <span className="text-primary-600 dark:text-primary-400">{settings.appName}</span>
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-300 leading-relaxed mb-8 max-w-3xl mx-auto">
              ما با هدف ساده‌سازی یادگیری ریاضیات برای دانش‌آموزان ایرانی گرد هم آمده‌ایم. 
              این پلتفرم با بهره‌گیری از جدیدترین تکنولوژی‌های هوش مصنوعی و محتوای آموزشی تعاملی، 
              مسیر یادگیری را برای شما لذت‌بخش می‌کند.
            </p>
            
            <div className="flex justify-center gap-6">
              <a href={settings.eitaaLink} target="_blank" rel="noreferrer" className="group flex flex-col items-center gap-2 transition-transform hover:-translate-y-1">
                 <div className="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-all">
                   <EitaaIcon />
                 </div>
                 <span className="text-xs font-bold text-gray-500">ایتا</span>
              </a>
              <a href={settings.rubikaLink} target="_blank" rel="noreferrer" className="group flex flex-col items-center gap-2 transition-transform hover:-translate-y-1">
                 <div className="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-all">
                   <RubikaIcon />
                 </div>
                 <span className="text-xs font-bold text-gray-500">روبیکا</span>
              </a>
            </div>
        </div>
      </div>

      {/* Creators Section - Flip Boxes */}
      <div className="mb-20">
          <h2 className="text-3xl font-bold text-center text-gray-900 dark:text-white mb-12 border-b pb-4 border-gray-200 dark:border-gray-700 inline-block w-full">
            سازندگان پروژه
          </h2>
          <div className="flex flex-wrap justify-center gap-10">
            {creators.map(creator => (
              <div key={creator.id} className="group w-full max-w-sm h-[400px] [perspective:1000px] cursor-pointer">
                <div className="relative w-full h-full transition-all duration-700 [transform-style:preserve-3d] group-hover:[transform:rotateY(180deg)] shadow-xl rounded-3xl">
                  
                  {/* FRONT SIDE */}
                  <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] rounded-3xl overflow-hidden bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700">
                    <div className="h-full flex flex-col">
                      <div className="flex-1 relative overflow-hidden">
                        <img 
                          src={creator.imageUrl} 
                          alt={creator.name} 
                          className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
                        <div className="absolute bottom-0 left-0 right-0 p-6 text-white text-center">
                          <h3 className="text-2xl font-bold mb-1 drop-shadow-md">{creator.name}</h3>
                          <p className="text-sm opacity-90 bg-white/20 inline-block px-3 py-1 rounded-full backdrop-blur-sm">{creator.role}</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* BACK SIDE */}
                  <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] rounded-3xl overflow-hidden bg-gradient-to-br from-accent-600 to-accent-800 text-white p-8 flex flex-col justify-center text-center shadow-2xl border-2 border-accent-400/30">
                    <div className="w-24 h-24 mx-auto mb-6 rounded-full border-4 border-white/30 overflow-hidden shadow-inner">
                       <img src={creator.imageUrl} alt={creator.name} className="w-full h-full object-cover" />
                    </div>
                    
                    <h3 className="text-xl font-bold mb-2">{creator.name}</h3>
                    <span className="text-accent-200 text-sm font-bold mb-6 block border-b border-white/10 pb-4">{creator.role}</span>
                    
                    <p className="text-white/90 text-sm leading-relaxed px-2 mb-4">
                         {creator.bio}
                    </p>
                  </div>
                  
                </div>
              </div>
            ))}
          </div>
      </div>

      {/* Contact Section */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
        {/* Contact Info */}
        <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 flex flex-col justify-center h-full">
          <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-8 flex items-center gap-2">
            <Phone className="text-primary-500" />
            تماس با ما
          </h2>
          <div className="space-y-6">
             <div className="flex items-center gap-4 text-gray-700 dark:text-gray-300 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl transition-colors hover:bg-primary-50 dark:hover:bg-primary-900/20">
               <div className="bg-primary-100 dark:bg-primary-900 p-3 rounded-full text-primary-600 dark:text-primary-400">
                 <Mail size={20} />
               </div>
               <div className="flex flex-col">
                  <span className="text-xs text-gray-500 font-bold mb-1">ایمیل پشتیبانی</span>
                  <span className="font-mono dir-ltr text-left">{settings.adminEmail}</span>
               </div>
             </div>
             
             <div className="flex items-center gap-4 text-gray-700 dark:text-gray-300 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl transition-colors hover:bg-primary-50 dark:hover:bg-primary-900/20">
               <div className="bg-primary-100 dark:bg-primary-900 p-3 rounded-full text-primary-600 dark:text-primary-400">
                 <Phone size={20} />
               </div>
               <div className="flex flex-col">
                  <span className="text-xs text-gray-500 font-bold mb-1">تلفن تماس</span>
                  <span className="font-mono dir-ltr text-left">{settings.phone}</span>
               </div>
             </div>

             <div className="flex items-center gap-4 text-gray-700 dark:text-gray-300 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-xl transition-colors hover:bg-primary-50 dark:hover:bg-primary-900/20">
               <div className="bg-primary-100 dark:bg-primary-900 p-3 rounded-full text-primary-600 dark:text-primary-400">
                 <MapPin size={20} />
               </div>
               <div className="flex flex-col">
                  <span className="text-xs text-gray-500 font-bold mb-1">آدرس ما</span>
                  <span>{settings.address}</span>
               </div>
             </div>
          </div>
        </div>

        {/* Send Message Form */}
        <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
          <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
             <Send className="text-accent-500" />
             ارسال پیام
          </h2>
          <p className="text-sm text-gray-500 mb-6">
            پیام شما مستقیماً به ایمیل <span className="font-bold text-gray-700 dark:text-gray-300">{settings.adminEmail}</span> ارسال می‌شود.
          </p>
          <form className="space-y-4" onSubmit={(e) => { e.preventDefault(); alert('پیام شما با موفقیت ارسال شد!'); }}>
            <div className="grid grid-cols-2 gap-4">
               <input 
                type="text" 
                placeholder="نام شما" 
                required
                className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 outline-none focus:border-accent-500 focus:ring-1 focus:ring-accent-500 transition-all" 
              />
              <input 
                type="text" 
                placeholder="شماره تماس" 
                className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 outline-none focus:border-accent-500 focus:ring-1 focus:ring-accent-500 transition-all" 
              />
            </div>
            <input 
              type="email" 
              placeholder="ایمیل شما" 
              required
              className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 outline-none focus:border-accent-500 focus:ring-1 focus:ring-accent-500 transition-all" 
            />
            <textarea 
              placeholder="متن پیام..." 
              rows={4} 
              required
              className="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 outline-none focus:border-accent-500 focus:ring-1 focus:ring-accent-500 resize-none transition-all"
            ></textarea>
            <button type="submit" className="w-full bg-gradient-to-r from-accent-600 to-accent-500 hover:from-accent-700 hover:to-accent-600 text-white font-bold py-3 rounded-xl transition-all transform hover:-translate-y-1 shadow-lg shadow-accent-500/30">
              ارسال پیام
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

--- frontend/src/pages/Admin.tsx ---
import React, { useState, useRef, useEffect } from 'react';
import { useAppContext } from '../AppContext';
import { useNavigate } from 'react-router-dom';
import { Lock, Plus, Trash, LayoutDashboard, Book, User, X, Image as ImageIcon, PlayCircle, MonitorPlay, HelpCircle, Pencil, Users, Upload, Loader2, Check, Settings } from 'lucide-react';
import { Book as BookType, Teacher as TeacherType, Video as VideoType, Paradox as ParadoxType, Settings as SettingsType, Creator as CreatorType } from '../types';
import { validateApiKey } from '../services/geminiService';

export const Admin: React.FC = () => {
  const { isAuthenticated, login, logout, books, teachers, videos, paradoxes, creators, settings, updateData, updateSettings } = useAppContext();
  const navigate = useNavigate();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [activeTab, setActiveTab] = useState<'dashboard' | 'books' | 'teachers' | 'videos' | 'paradoxes' | 'settings'>('dashboard');

  // Modal State
  const [isBookModalOpen, setIsBookModalOpen] = useState(false);
  const [isTeacherModalOpen, setIsTeacherModalOpen] = useState(false);
  const [isVideoModalOpen, setIsVideoModalOpen] = useState(false);
  const [isParadoxModalOpen, setIsParadoxModalOpen] = useState(false);
  const [isCreatorModalOpen, setIsCreatorModalOpen] = useState(false);

  // Edit State
  const [editingId, setEditingId] = useState<string | null>(null);

  // Form States
  const [newBook, setNewBook] = useState<Partial<BookType>>({});
  const [newTeacher, setNewTeacher] = useState<Partial<TeacherType>>({});
  const [newVideo, setNewVideo] = useState<Partial<VideoType>>({});
  const [newParadox, setNewParadox] = useState<Partial<ParadoxType>>({});
  const [newCreator, setNewCreator] = useState<Partial<CreatorType>>({});
  const [tempSettings, setTempSettings] = useState<SettingsType>(settings);

  // API Key Test State
  const [isTestingKey, setIsTestingKey] = useState(false);
  const [keyStatus, setKeyStatus] = useState<'idle' | 'success' | 'error'>('idle');

  const fileInputRef = useRef<HTMLInputElement>(null);
  const teacherFileInputRef = useRef<HTMLInputElement>(null);
  const videoFileInputRef = useRef<HTMLInputElement>(null);
  const creatorFileInputRef = useRef<HTMLInputElement>(null);
  const logoInputRef = useRef<HTMLInputElement>(null);

  // Initialize temp settings when settings change
  useEffect(() => {
    setTempSettings(settings);
  }, [settings]);

  // Login Logic
  const handleLogin = (e: React.FormEvent) => {
    e.preventDefault();
    if (email === 'admin@admin.com' && password === 'admin') {
      login();
    } else {
      alert('ایمیل یا رمز عبور اشتباه است (demo: admin@admin.com / admin)');
    }
  };

  const handleLogout = () => {
    logout();
    navigate('/');
  };

  // --- Reset & Open Modals ---
  
  const openBookModal = (book?: BookType) => {
    if (book) {
      setNewBook(book);
      setEditingId(book.id);
    } else {
      setNewBook({ rating: 5, imageUrl: '' });
      setEditingId(null);
    }
    setIsBookModalOpen(true);
  };

  const openTeacherModal = (teacher?: TeacherType) => {
    if (teacher) {
      setNewTeacher(teacher);
      setEditingId(teacher.id);
    } else {
      setNewTeacher({ imageUrl: '' });
      setEditingId(null);
    }
    setIsTeacherModalOpen(true);
  };

  const openVideoModal = (video?: VideoType) => {
    if (video) {
      setNewVideo(video);
      setEditingId(video.id);
    } else {
      setNewVideo({ thumbnailUrl: '', duration: '' });
      setEditingId(null);
    }
    setIsVideoModalOpen(true);
  };

  const openParadoxModal = (paradox?: ParadoxType) => {
    if (paradox) {
      setNewParadox(paradox);
      setEditingId(paradox.id);
    } else {
      setNewParadox({});
      setEditingId(null);
    }
    setIsParadoxModalOpen(true);
  };

  const openCreatorModal = (creator: CreatorType) => {
    setNewCreator(creator);
    setEditingId(creator.id); // Creators always exist, we edit them
    setIsCreatorModalOpen(true);
  };

  const closeModals = () => {
    setIsBookModalOpen(false);
    setIsTeacherModalOpen(false);
    setIsVideoModalOpen(false);
    setIsParadoxModalOpen(false);
    setIsCreatorModalOpen(false);
    setEditingId(null);
  };

  // --- Image Handlers ---

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>, setter: React.Dispatch<React.SetStateAction<any>>, field: string = 'imageUrl') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setter((prev: any) => ({ ...prev, [field]: reader.result as string }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setTempSettings(prev => ({ ...prev, appLogoUrl: reader.result as string }));
      };
      reader.readAsDataURL(file);
    }
  };

  // --- API Key Test ---
  const handleTestApiKey = async () => {
    if (!tempSettings.apiKey) return;
    setIsTestingKey(true);
    setKeyStatus('idle');
    try {
        const isValid = await validateApiKey(tempSettings.apiKey);
        setKeyStatus(isValid ? 'success' : 'error');
        if (!isValid) alert('کلید API معتبر نیست یا اتصال برقرار نشد.');
    } catch (e) {
        setKeyStatus('error');
    } finally {
        setIsTestingKey(false);
    }
  };

  // --- Save Handlers ---

  const handleSaveBook = (e: React.FormEvent) => {
    e.preventDefault();
    if (!newBook.title) return;

    if (editingId) {
      const updated = books.map(b => b.id === editingId ? { ...b, ...newBook } as BookType : b);
      updateData('books', updated);
    } else {
      const item: BookType = {
        id: Date.now().toString(),
        title: newBook.title!,
        author: newBook.author || 'نامشخص',
        description: newBook.description || '',
        subject: newBook.subject || 'عمومی',
        imageUrl: newBook.imageUrl || 'https://picsum.photos/200/300',
        downloadUrl: newBook.downloadUrl || '#',
        rating: newBook.rating || 5,
      };
      updateData('books', [...books, item]);
    }
    closeModals();
  };

  const handleSaveTeacher = (e: React.FormEvent) => {
    e.preventDefault();
    if (!newTeacher.name) return;

    if (editingId) {
      const updated = teachers.map(t => t.id === editingId ? { ...t, ...newTeacher } as TeacherType : t);
      updateData('teachers', updated);
    } else {
      const item: TeacherType = {
        id: Date.now().toString(),
        name: newTeacher.name!,
        bio: newTeacher.bio || '',
        experience: newTeacher.experience || '',
        phone: newTeacher.phone || '',
        email: newTeacher.email || '',
        imageUrl: newTeacher.imageUrl || 'https://picsum.photos/300/300',
      };
      updateData('teachers', [...teachers, item]);
    }
    closeModals();
  };

  const handleSaveVideo = (e: React.FormEvent) => {
    e.preventDefault();
    if (!newVideo.title) return;

    if (editingId) {
      const updated = videos.map(v => v.id === editingId ? { ...v, ...newVideo } as VideoType : v);
      updateData('videos', updated);
    } else {
      const item: VideoType = {
        id: Date.now().toString(),
        title: newVideo.title!,
        tutor: newVideo.tutor || '',
        category: newVideo.category || '',
        videoUrl: newVideo.videoUrl || '',
        duration: newVideo.duration || '00:00',
        thumbnailUrl: newVideo.thumbnailUrl || 'https://picsum.photos/300/180',
      };
      updateData('videos', [...videos, item]);
    }
    closeModals();
  };

  const handleSaveParadox = (e: React.FormEvent) => {
    e.preventDefault();
    if (!newParadox.title) return;

    if (editingId) {
      const updated = paradoxes.map(p => p.id === editingId ? { ...p, ...newParadox } as ParadoxType : p);
      updateData('paradoxes', updated);
    } else {
      const item: ParadoxType = {
        id: Date.now().toString(),
        title: newParadox.title!,
        summary: newParadox.summary || '',
        content: newParadox.content || '',
      };
      updateData('paradoxes', [...paradoxes, item]);
    }
    closeModals();
  };

  const handleSaveCreator = (e: React.FormEvent) => {
    e.preventDefault();
    if (!newCreator.name || !editingId) return;
    
    const updated = creators.map(c => c.id === editingId ? { ...c, ...newCreator } as CreatorType : c);
    updateData('creators', updated);
    closeModals();
  };

  const handleSaveSettings = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      // مستقیم ذخیره می‌کنیم تا تداخل ایجاد نشود
      await updateSettings(tempSettings);
      alert('تنظیمات با موفقیت در سرور ذخیره شد.');
    } catch (error) {
      console.error(error);
      alert('خطا در ذخیره تنظیمات.');
    }
  };

  // --- Delete Handlers ---

  const deleteItem = (type: 'books' | 'teachers' | 'videos' | 'paradoxes', id: string) => {
    if (window.confirm('آیا از حذف این آیتم اطمینان دارید؟')) {
      switch (type) {
        case 'books': updateData('books', books.filter(b => b.id !== id)); break;
        case 'teachers': updateData('teachers', teachers.filter(t => t.id !== id)); break;
        case 'videos': updateData('videos', videos.filter(v => v.id !== id)); break;
        case 'paradoxes': updateData('paradoxes', paradoxes.filter(p => p.id !== id)); break;
      }
    }
  };

  if (!isAuthenticated) {
    return (
      <div className="min-h-[80vh] flex items-center justify-center">
        <div className="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md border border-gray-100 dark:border-gray-700">
          <div className="flex justify-center mb-6 text-primary-600 dark:text-primary-400">
            <div className="bg-primary-50 dark:bg-gray-700 p-4 rounded-full">
              <Lock size={32} />
            </div>
          </div>
          <h2 className="text-2xl font-bold text-center text-gray-900 dark:text-white mb-2">ورود به پنل مدیریت</h2>
          <p className="text-center text-gray-500 mb-8 text-sm">اطلاعات ورود (demo: admin@admin.com / admin)</p>
          <form onSubmit={handleLogin} className="space-y-4">
            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-3 rounded-lg border dark:border-gray-600 dark:bg-gray-700 dark:text-white" placeholder="ایمیل" dir="ltr" />
            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 rounded-lg border dark:border-gray-600 dark:bg-gray-700 dark:text-white" placeholder="رمز عبور" dir="ltr" />
            <button className="w-full bg-primary-600 text-white py-3 rounded-lg font-bold">ورود</button>
          </form>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col md:flex-row min-h-screen bg-gray-50 dark:bg-gray-900">
      {/* Sidebar */}
      <aside className="w-full md:w-64 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 p-4">
        <div className="flex items-center gap-2 mb-8 px-2">
          <div className="w-8 h-8 bg-accent-500 rounded-lg"></div>
          <span className="font-bold text-lg dark:text-white">پنل ادمین</span>
        </div>
        <nav className="space-y-2">
          {[
            { id: 'dashboard', icon: LayoutDashboard, label: 'داشبورد' },
            { id: 'settings', icon: Settings, label: 'تنظیمات و سازندگان' },
            { id: 'books', icon: Book, label: 'مدیریت کتاب‌ها' },
            { id: 'teachers', icon: User, label: 'مدیریت معلمین' },
            { id: 'videos', icon: PlayCircle, label: 'مدیریت ویدیوها' },
            { id: 'paradoxes', icon: HelpCircle, label: 'مدیریت پارادوکس‌ها' },
          ].map(item => (
            <button 
              key={item.id}
              onClick={() => setActiveTab(item.id as any)}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${activeTab === item.id ? 'bg-primary-50 dark:bg-primary-900/20 text-primary-600 dark:text-primary-400' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700'}`}
            >
              <item.icon size={20} />
              <span>{item.label}</span>
            </button>
          ))}
          <button onClick={handleLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 mt-8">
            <span>خروج</span>
          </button>
        </nav>
      </aside>

      {/* Main Content */}
      <main className="flex-1 p-8 overflow-auto">
        
        {/* DASHBOARD */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <h2 className="text-2xl font-bold text-gray-900 dark:text-white">آمار کلی سایت</h2>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div className="text-gray-500 text-sm mb-1">تعداد کتاب‌ها</div>
                <div className="text-3xl font-bold text-gray-900 dark:text-white">{books.length}</div>
              </div>
              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div className="text-gray-500 text-sm mb-1">تعداد معلمین</div>
                <div className="text-3xl font-bold text-primary-500">{teachers.length}</div>
              </div>
              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div className="text-gray-500 text-sm mb-1">ویدیوها</div>
                <div className="text-3xl font-bold text-accent-500">{videos.length}</div>
              </div>
               <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div className="text-gray-500 text-sm mb-1">پارادوکس‌ها</div>
                <div className="text-3xl font-bold text-indigo-500">{paradoxes.length}</div>
              </div>
            </div>
          </div>
        )}

        {/* SETTINGS */}
        {activeTab === 'settings' && (
          <div className="space-y-8">
             <h2 className="text-2xl font-bold text-gray-900 dark:text-white">تنظیمات سایت و سازندگان</h2>
             
             {/* General Settings */}
             <form onSubmit={handleSaveSettings} className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div className="col-span-1 md:col-span-2">
                    <h3 className="font-bold text-lg text-primary-600 mb-4 border-b pb-2">مشخصات اصلی</h3>
                 </div>
                 
                 {/* Logo Upload */}
                 <div className="col-span-1 md:col-span-2 flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-900/50 hover:bg-gray-100 dark:hover:bg-gray-900 transition-colors cursor-pointer group" onClick={() => logoInputRef.current?.click()}>
                    <div className="flex flex-col items-center gap-2">
                        {tempSettings.appLogoUrl ? (
                             <div className="relative">
                                <img src={tempSettings.appLogoUrl} alt="Logo Preview" className="h-24 w-auto object-contain" />
                                <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded">
                                     <Pencil className="text-white" />
                                </div>
                             </div>
                        ) : (
                            <div className="text-gray-400 flex flex-col items-center">
                                <Upload size={32} />
                                <span className="text-sm mt-2">آپلود لوگو (PNG, SVG)</span>
                            </div>
                        )}
                    </div>
                 </div>
                 <input type="file" ref={logoInputRef} className="hidden" onChange={handleLogoUpload} accept="image/*" />

                 <div className="space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">نام نرم افزار / سایت</label>
                    <input type="text" value={tempSettings.appName} onChange={e => setTempSettings({...tempSettings, appName: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                 </div>
                 <div className="space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">ایمیل ادمین (برای دریافت پیام)</label>
                    <input type="text" value={tempSettings.adminEmail} onChange={e => setTempSettings({...tempSettings, adminEmail: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
                 </div>

                 {/* API KEY SECTION */}
                 <div className="col-span-1 md:col-span-2 space-y-2 border-t border-gray-100 dark:border-gray-700 pt-4 mt-2">
                    <h3 className="font-bold text-lg text-primary-600 mb-2">تنظیمات هوش مصنوعی (Google Gemini)</h3>
                    <label className="text-sm font-bold dark:text-gray-300">کلید API (API Key)</label>
                    <div className="flex gap-2">
                        <input 
                            type="password" 
                            value={tempSettings.apiKey || ''} 
                            onChange={e => {
                                setTempSettings({...tempSettings, apiKey: e.target.value});
                                setKeyStatus('idle');
                            }} 
                            className="flex-1 p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white font-mono text-sm" 
                            dir="ltr"
                            placeholder="AIza..."
                        />
                        {/* دکمه تست حذف شد تا در ذخیره اختلال ایجاد نکند */}
                    </div>
                 </div>

                 <div className="col-span-1 md:col-span-2 mt-4">
                    <h3 className="font-bold text-lg text-primary-600 mb-4 border-b pb-2">شبکه‌های اجتماعی و تماس</h3>
                 </div>
                 <div className="space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">لینک کانال ایتا</label>
                    <input type="text" value={tempSettings.eitaaLink} onChange={e => setTempSettings({...tempSettings, eitaaLink: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
                 </div>
                 <div className="space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">لینک کانال روبیکا</label>
                    <input type="text" value={tempSettings.rubikaLink} onChange={e => setTempSettings({...tempSettings, rubikaLink: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
                 </div>
                 <div className="space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">تلفن تماس</label>
                    <input type="text" value={tempSettings.phone} onChange={e => setTempSettings({...tempSettings, phone: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
                 </div>
                 <div className="space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">آدرس</label>
                    <input type="text" value={tempSettings.address} onChange={e => setTempSettings({...tempSettings, address: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
                 </div>
                 
                 <div className="col-span-1 md:col-span-2 space-y-2">
                    <label className="text-sm font-bold dark:text-gray-300">متن کپی‌رایت فوتر</label>
                    <textarea value={tempSettings.copyrightText} onChange={e => setTempSettings({...tempSettings, copyrightText: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows={2} />
                 </div>

                 <div className="col-span-1 md:col-span-2 flex justify-end">
                    <button className="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 shadow-lg shadow-green-600/30">ذخیره تغییرات</button>
                 </div>
             </form>

             {/* Creators Management */}
             <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                <h3 className="font-bold text-lg text-primary-600 mb-4 border-b pb-2 flex items-center gap-2">
                  <Users size={20} />
                  مدیریت سازندگان (درباره ما)
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                   {creators.map(creator => (
                     <div key={creator.id} className="flex items-center gap-4 p-4 border rounded-lg dark:border-gray-700">
                        <img src={creator.imageUrl} alt={creator.name} className="w-16 h-16 rounded-full object-cover" />
                        <div className="flex-1">
                           <div className="font-bold dark:text-white">{creator.name}</div>
                           <div className="text-xs text-gray-500">{creator.role}</div>
                        </div>
                        <button onClick={() => openCreatorModal(creator)} className="p-2 text-blue-500 hover:bg-blue-50 rounded transition-colors">
                           <Pencil size={18} />
                        </button>
                     </div>
                   ))}
                </div>
             </div>
          </div>
        )}

        {/* BOOKS */}
        {activeTab === 'books' && (
          <div className="space-y-6">
             <div className="flex justify-between items-center">
               <h2 className="text-2xl font-bold text-gray-900 dark:text-white">لیست کتاب‌ها</h2>
               <button onClick={() => openBookModal()} className="bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-primary-700">
                 <Plus size={18} /> افزودن کتاب
               </button>
             </div>
             <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
               <table className="w-full text-right">
                 <thead className="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                   <tr>
                     <th className="p-4 text-sm">عنوان</th>
                     <th className="p-4 text-sm">نویسنده</th>
                     <th className="p-4 text-sm">عملیات</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                   {books.map(book => (
                     <tr key={book.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                       <td className="p-4 dark:text-white">{book.title}</td>
                       <td className="p-4 dark:text-gray-400">{book.author}</td>
                       <td className="p-4 flex gap-2">
                         <button onClick={() => openBookModal(book)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil size={18} /></button>
                         <button onClick={() => deleteItem('books', book.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash size={18} /></button>
                       </td>
                     </tr>
                   ))}
                 </tbody>
               </table>
             </div>
          </div>
        )}

        {/* TEACHERS */}
        {activeTab === 'teachers' && (
          <div className="space-y-6">
             <div className="flex justify-between items-center">
               <h2 className="text-2xl font-bold text-gray-900 dark:text-white">لیست معلمین</h2>
               <button onClick={() => openTeacherModal()} className="bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-primary-700">
                 <Plus size={18} /> افزودن معلم
               </button>
             </div>
             <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
               <table className="w-full text-right">
                 <thead className="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                   <tr>
                     <th className="p-4 text-sm">نام</th>
                     <th className="p-4 text-sm">سابقه</th>
                     <th className="p-4 text-sm">عملیات</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                   {teachers.map(teacher => (
                     <tr key={teacher.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                       <td className="p-4 dark:text-white">{teacher.name}</td>
                       <td className="p-4 dark:text-gray-400">{teacher.experience}</td>
                       <td className="p-4 flex gap-2">
                         <button onClick={() => openTeacherModal(teacher)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil size={18} /></button>
                         <button onClick={() => deleteItem('teachers', teacher.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash size={18} /></button>
                       </td>
                     </tr>
                   ))}
                 </tbody>
               </table>
             </div>
          </div>
        )}

        {/* VIDEOS */}
        {activeTab === 'videos' && (
           <div className="space-y-6">
             <div className="flex justify-between items-center">
               <h2 className="text-2xl font-bold text-gray-900 dark:text-white">لیست ویدیوها</h2>
               <button onClick={() => openVideoModal()} className="bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-primary-700">
                 <Plus size={18} /> افزودن ویدیو
               </button>
             </div>
             <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
               <table className="w-full text-right">
                 <thead className="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                   <tr>
                     <th className="p-4 text-sm">عنوان</th>
                     <th className="p-4 text-sm">مدرس</th>
                     <th className="p-4 text-sm">پایه</th>
                     <th className="p-4 text-sm">عملیات</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                   {videos.map(video => (
                     <tr key={video.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                       <td className="p-4 dark:text-white">{video.title}</td>
                       <td className="p-4 dark:text-gray-400">{video.tutor}</td>
                       <td className="p-4 dark:text-gray-400">{video.category}</td>
                       <td className="p-4 flex gap-2">
                         <button onClick={() => openVideoModal(video)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil size={18} /></button>
                         <button onClick={() => deleteItem('videos', video.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash size={18} /></button>
                       </td>
                     </tr>
                   ))}
                 </tbody>
               </table>
             </div>
          </div>
        )}

        {/* PARADOXES */}
        {activeTab === 'paradoxes' && (
           <div className="space-y-6">
             <div className="flex justify-between items-center">
               <h2 className="text-2xl font-bold text-gray-900 dark:text-white">مدیریت پارادوکس‌ها</h2>
               <button onClick={() => openParadoxModal()} className="bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-primary-700">
                 <Plus size={18} /> افزودن پارادوکس
               </button>
             </div>
             <div className="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden">
               <table className="w-full text-right">
                 <thead className="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                   <tr>
                     <th className="p-4 text-sm">عنوان</th>
                     <th className="p-4 text-sm">خلاصه</th>
                     <th className="p-4 text-sm">عملیات</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                   {paradoxes.map(item => (
                     <tr key={item.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                       <td className="p-4 dark:text-white font-bold">{item.title}</td>
                       <td className="p-4 dark:text-gray-400 text-sm truncate max-w-xs">{item.summary}</td>
                       <td className="p-4 flex gap-2">
                         <button onClick={() => openParadoxModal(item)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil size={18} /></button>
                         <button onClick={() => deleteItem('paradoxes', item.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash size={18} /></button>
                       </td>
                     </tr>
                   ))}
                 </tbody>
               </table>
             </div>
          </div>
        )}

      </main>

      {/* --- MODALS --- */}

      {/* Book Modal */}
      {isBookModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between mb-6">
              <h3 className="text-xl font-bold dark:text-white">{editingId ? 'ویرایش کتاب' : 'افزودن کتاب'}</h3>
              <button onClick={closeModals}><X size={24} className="text-gray-400" /></button>
            </div>
            <form onSubmit={handleSaveBook} className="space-y-4">
              <div className="flex flex-col items-center mb-4">
                <div className="w-32 h-48 border-2 border-dashed rounded-lg flex items-center justify-center overflow-hidden relative bg-gray-100 dark:bg-gray-700 cursor-pointer" onClick={() => fileInputRef.current?.click()}>
                  {newBook.imageUrl ? <img src={newBook.imageUrl} className="w-full h-full object-cover" /> : <ImageIcon className="text-gray-400" />}
                </div>
                <input type="file" ref={fileInputRef} className="hidden" onChange={(e) => handleImageUpload(e, setNewBook)} accept="image/*" />
              </div>
              <input placeholder="عنوان" value={newBook.title || ''} onChange={e => setNewBook({...newBook, title: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="نویسنده" value={newBook.author || ''} onChange={e => setNewBook({...newBook, author: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="موضوع" value={newBook.subject || ''} onChange={e => setNewBook({...newBook, subject: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              <textarea placeholder="توضیحات" value={newBook.description || ''} onChange={e => setNewBook({...newBook, description: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows={3} />
              <input placeholder="لینک دانلود" value={newBook.downloadUrl || ''} onChange={e => setNewBook({...newBook, downloadUrl: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
              <button className="w-full bg-primary-600 text-white py-3 rounded font-bold hover:bg-primary-700">{editingId ? 'بروزرسانی' : 'ذخیره'}</button>
            </form>
          </div>
        </div>
      )}

      {/* Teacher Modal */}
      {isTeacherModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between mb-6">
              <h3 className="text-xl font-bold dark:text-white">{editingId ? 'ویرایش معلم' : 'افزودن معلم'}</h3>
              <button onClick={closeModals}><X size={24} className="text-gray-400" /></button>
            </div>
            <form onSubmit={handleSaveTeacher} className="space-y-4">
              <div className="flex flex-col items-center mb-4">
                <div className="w-32 h-32 rounded-full border-2 border-dashed flex items-center justify-center overflow-hidden relative bg-gray-100 dark:bg-gray-700 cursor-pointer" onClick={() => teacherFileInputRef.current?.click()}>
                  {newTeacher.imageUrl ? <img src={newTeacher.imageUrl} className="w-full h-full object-cover" /> : <User className="text-gray-400" />}
                </div>
                <input type="file" ref={teacherFileInputRef} className="hidden" onChange={(e) => handleImageUpload(e, setNewTeacher)} accept="image/*" />
              </div>
              <input placeholder="نام و نام خانوادگی" value={newTeacher.name || ''} onChange={e => setNewTeacher({...newTeacher, name: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="سابقه" value={newTeacher.experience || ''} onChange={e => setNewTeacher({...newTeacher, experience: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              <input placeholder="تلفن" value={newTeacher.phone || ''} onChange={e => setNewTeacher({...newTeacher, phone: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
              <input placeholder="ایمیل" value={newTeacher.email || ''} onChange={e => setNewTeacher({...newTeacher, email: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
              <textarea placeholder="بیوگرافی" value={newTeacher.bio || ''} onChange={e => setNewTeacher({...newTeacher, bio: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows={3} />
              <button className="w-full bg-primary-600 text-white py-3 rounded font-bold hover:bg-primary-700">{editingId ? 'بروزرسانی' : 'ذخیره'}</button>
            </form>
          </div>
        </div>
      )}

      {/* Video Modal */}
      {isVideoModalOpen && (
         <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between mb-6">
              <h3 className="text-xl font-bold dark:text-white">{editingId ? 'ویرایش ویدیو' : 'افزودن ویدیو'}</h3>
              <button onClick={closeModals}><X size={24} className="text-gray-400" /></button>
            </div>
            <form onSubmit={handleSaveVideo} className="space-y-4">
              <div className="flex flex-col items-center mb-4">
                <div className="w-48 h-28 border-2 border-dashed rounded-lg flex items-center justify-center overflow-hidden relative bg-gray-100 dark:bg-gray-700 cursor-pointer" onClick={() => videoFileInputRef.current?.click()}>
                  {newVideo.thumbnailUrl ? <img src={newVideo.thumbnailUrl} className="w-full h-full object-cover" /> : <MonitorPlay className="text-gray-400" />}
                </div>
                <input type="file" ref={videoFileInputRef} className="hidden" onChange={(e) => handleImageUpload(e, setNewVideo, 'thumbnailUrl')} accept="image/*" />
              </div>
              <input placeholder="عنوان ویدیو" value={newVideo.title || ''} onChange={e => setNewVideo({...newVideo, title: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="نام مدرس" value={newVideo.tutor || ''} onChange={e => setNewVideo({...newVideo, tutor: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" />
              <input placeholder="پایه (دسته‌بندی)" value={newVideo.category || ''} onChange={e => setNewVideo({...newVideo, category: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="مدت زمان (مثلا 10:00)" value={newVideo.duration || ''} onChange={e => setNewVideo({...newVideo, duration: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" dir="ltr" />
              <textarea placeholder="کد امبد (IFrame) از آپارات" value={newVideo.videoUrl || ''} onChange={e => setNewVideo({...newVideo, videoUrl: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white font-mono text-xs" rows={4} dir="ltr" />
              <button className="w-full bg-primary-600 text-white py-3 rounded font-bold hover:bg-primary-700">{editingId ? 'بروزرسانی' : 'ذخیره'}</button>
            </form>
          </div>
        </div>
      )}

      {/* Paradox Modal */}
      {isParadoxModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between mb-6">
              <h3 className="text-xl font-bold dark:text-white">{editingId ? 'ویرایش پارادوکس' : 'افزودن پارادوکس'}</h3>
              <button onClick={closeModals}><X size={24} className="text-gray-400" /></button>
            </div>
            <form onSubmit={handleSaveParadox} className="space-y-4">
              <input placeholder="عنوان پارادوکس" value={newParadox.title || ''} onChange={e => setNewParadox({...newParadox, title: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="خلاصه کوتاه" value={newParadox.summary || ''} onChange={e => setNewParadox({...newParadox, summary: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <textarea placeholder="شرح کامل و محتوای پارادوکس..." value={newParadox.content || ''} onChange={e => setNewParadox({...newParadox, content: e.target.value})} className="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white min-h-[200px]" required />
              <button className="w-full bg-primary-600 text-white py-3 rounded font-bold hover:bg-primary-700">{editingId ? 'بروزرسانی' : 'ذخیره'}</button>
            </form>
          </div>
        </div>
      )}

      {/* Creator Modal */}
      {isCreatorModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <div className="flex justify-between mb-6">
              <h3 className="text-xl font-bold dark:text-white">ویرایش سازنده</h3>
              <button onClick={closeModals}><X size={24} className="text-gray-400" /></button>
            </div>
            <form onSubmit={handleSaveCreator} className="space-y-4">
               <div className="flex flex-col items-center mb-4">
                <div className="w-24 h-24 rounded-full border-2 border-dashed flex items-center justify-center overflow-hidden relative bg-gray-100 dark:bg-gray-700 cursor-pointer" onClick={() => creatorFileInputRef.current?.click()}>
                  {newCreator.imageUrl ? <img src={newCreator.imageUrl} className="w-full h-full object-cover" /> : <User className="text-gray-400" />}
                </div>
                <input type="file" ref={creatorFileInputRef} className="hidden" onChange={(e) => handleImageUpload(e, setNewCreator)} accept="image/*" />
              </div>
              <input placeholder="نام" value={newCreator.name || ''} onChange={e => setNewCreator({...newCreator, name: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <input placeholder="نقش / پایه" value={newCreator.role || ''} onChange={e => setNewCreator({...newCreator, role: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" required />
              <textarea placeholder="بیوگرافی کوتاه" value={newCreator.bio || ''} onChange={e => setNewCreator({...newCreator, bio: e.target.value})} className="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows={3} required />
              <button className="w-full bg-primary-600 text-white py-2 rounded font-bold hover:bg-primary-700">ذخیره تغییرات</button>
            </form>
          </div>
        </div>
      )}

    </div>
  );
};

--- frontend/src/pages/Books.tsx ---
import React from 'react';
import { useAppContext } from '../AppContext';
import { Star, Download, BookOpen } from 'lucide-react';

export const Books: React.FC = () => {
  const { books } = useAppContext();

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-8 border-r-4 border-primary-500 pr-4">
        کتابخانه ریاضی
      </h1>
      
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {books.map(book => (
          <div key={book.id} className="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden hover:shadow-lg transition-all duration-300 flex flex-col">
            <div className="h-64 overflow-hidden relative group bg-gray-100 dark:bg-gray-900">
              {book.imageUrl ? (
                <img src={book.imageUrl} alt={book.title} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-gray-400">
                  <BookOpen size={48} />
                </div>
              )}
              <div className="absolute top-2 right-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                <Star size={12} fill="currentColor" />
                {book.rating}
              </div>
              <div className="absolute top-2 left-2 bg-primary-600/90 text-white text-xs px-2 py-1 rounded shadow-sm">
                {book.subject}
              </div>
            </div>
            
            <div className="p-5 flex-1 flex flex-col">
              <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1">{book.title}</h3>
              <p className="text-sm text-primary-600 dark:text-primary-400 font-medium mb-2">{book.author}</p>
              
              <div className="bg-gray-50 dark:bg-gray-700/30 p-3 rounded-lg mb-4 flex-1">
                <p className="text-sm text-gray-600 dark:text-gray-300 line-clamp-4 leading-relaxed">
                  {book.description}
                </p>
              </div>
              
              <div className="mt-auto pt-2">
                <a 
                  href={book.downloadUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="w-full py-2.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-lg shadow-primary-600/20 transition-all flex items-center justify-center gap-2 text-sm font-bold"
                >
                  <Download size={18} />
                  دانلود فایل
                </a>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

--- frontend/src/pages/Home.tsx ---
import React, { useState, useRef, useEffect } from 'react';
import { Send, Loader2, Sparkles, BookOpen, User, PlayCircle, AlertTriangle, GraduationCap, Mic, MicOff, ClipboardPaste, Image as ImageIcon, X, ArrowLeft } from 'lucide-react';
import { solveMathProblem } from '../services/geminiService';
import { Link } from 'react-router-dom';
import { useAppContext } from '../AppContext';

export const Home: React.FC = () => {
  const [input, setInput] = useState('');
  const [image, setImage] = useState<string | null>(null);
  const [response, setResponse] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [isListening, setIsListening] = useState(false);
  
  const { settings } = useAppContext();
  
  const fileInputRef = useRef<HTMLInputElement>(null);
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  // Handle Paste Event for Images
  useEffect(() => {
    const handlePaste = (e: ClipboardEvent) => {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const blob = items[i].getAsFile();
          if (blob) {
            const reader = new FileReader();
            reader.onload = (event) => {
              setImage(event.target?.result as string);
            };
            reader.readAsDataURL(blob);
          }
        }
      }
    };

    window.addEventListener('paste', handlePaste);
    return () => {
      window.removeEventListener('paste', handlePaste);
    };
  }, []);

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setImage(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  const startListening = () => {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('مرورگر شما از قابلیت تایپ صوتی پشتیبانی نمی‌کند.');
      return;
    }

    const SpeechRecognition = (window as any).webkitSpeechRecognition || (window as any).SpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'fa-IR';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
      setIsListening(true);
    };

    recognition.onresult = (event: any) => {
      const transcript = event.results[0][0].transcript;
      setInput(prev => prev + ' ' + transcript);
      setIsListening(false);
    };

    recognition.onerror = (event: any) => {
      console.error(event.error);
      setIsListening(false);
    };

    recognition.onend = () => {
      setIsListening(false);
    };

    recognition.start();
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input && !image) return;
    
    if (!settings.apiKey) {
        setError('کلید API تنظیم نشده است. لطفاً با مدیر سایت تماس بگیرید.');
        return;
    }

    setLoading(true);
    setError(null);
    setResponse(null);

    try {
      let base64Data = undefined;
      let mimeType = 'image/jpeg';

      if (image) {
        // Extract proper mime type from data URL
        const match = image.match(/^data:(.+);base64,(.+)$/);
        if (match) {
          mimeType = match[1];
          base64Data = match[2];
        } else {
          // Fallback
          base64Data = image.split(',')[1];
        }
      }

      const result = await solveMathProblem(input, base64Data, mimeType, settings.apiKey);
      setResponse(result);
    } catch (err: any) {
      setError(err.message || 'خطایی رخ داد.');
    } finally {
      setLoading(false);
    }
  };

  const clearImage = () => {
    setImage(null);
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  return (
    <div className="relative font-sans selection:bg-primary-200 selection:text-primary-900">
      
      {/* Background is now handled in Layout via AnimatedBackground component */}

      <div className="max-w-6xl mx-auto px-4 py-12 sm:py-16 relative z-10">
        
        {/* Hero Header */}
        <div className="text-center mb-12 relative">
          <div className="inline-flex items-center gap-2 px-5 py-2 rounded-full bg-white/60 dark:bg-gray-800/60 backdrop-blur-md border border-primary-200 dark:border-primary-900 shadow-lg text-primary-700 dark:text-primary-300 text-sm font-bold mb-6 animate-in slide-in-from-top-4 fade-in duration-700">
            <Sparkles size={16} className="animate-pulse text-accent-500" />
            <span>پاسخ‌دهی هوشمند • حل مسائل درسی</span>
          </div>
          
          <h1 className="text-5xl md:text-7xl font-black text-gray-900 dark:text-white tracking-tighter leading-tight mb-6 drop-shadow-sm">
            <span className="block">مسائل ریاضی رو</span>
            <span className="bg-clip-text text-transparent bg-gradient-to-r from-primary-600 via-accent-500 to-primary-600 animate-pulse-glow bg-[length:200%_auto]">
              سـاده و سریع
            </span>
             <span className="block">حل کن!</span>
          </h1>
          
          <p className="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto leading-8 font-medium">
            عکس مسئله رو بفرست یا سوالت رو بنویس؛ من برات توضیح میدم.
          </p>
        </div>

        {/* Main Interaction Area */}
        <div className="relative max-w-4xl mx-auto z-20">
           <div className="absolute -top-6 -right-6 w-20 h-20 bg-accent-400/40 rounded-2xl rotate-12 blur-xl animate-pulse"></div>
           <div className="absolute -bottom-6 -left-6 w-24 h-24 bg-primary-400/40 rounded-full blur-xl animate-pulse-glow"></div>

          <div className="bg-white/70 dark:bg-gray-800/60 backdrop-blur-2xl rounded-[2.5rem] shadow-[0_20px_60px_-15px_rgba(139,92,246,0.2)] dark:shadow-black/50 border border-white/50 dark:border-white/10 overflow-hidden transition-all">
            
            <div className="p-6 md:p-8">
              <form onSubmit={handleSubmit} className="space-y-4">
                
                {/* Combined Input Area */}
                <div className="relative bg-white/50 dark:bg-gray-900/40 rounded-3xl border-2 border-transparent focus-within:border-primary-400 dark:focus-within:border-primary-600 transition-all">
                  
                  <textarea
                    ref={textareaRef}
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    placeholder="سوالت رو اینجا بنویس یا عکس مسئله رو بچسبون (Ctrl+V)..."
                    className="w-full min-h-[160px] bg-transparent resize-none outline-none text-xl md:text-2xl text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-600 leading-relaxed p-6"
                    dir="rtl"
                  />

                  {/* Image Preview */}
                  {image && (
                    <div className="px-6 pb-4">
                      <div className="relative inline-block group">
                        <img src={image} alt="Preview" className="h-32 w-auto rounded-xl border border-gray-200 dark:border-gray-700 shadow-md" />
                        <button 
                          type="button"
                          onClick={clearImage}
                          className="absolute -top-2 -right-2 bg-red-500 text-white p-1 rounded-full shadow-lg hover:scale-110 transition-transform"
                        >
                          <X size={14} />
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Toolbar */}
                  <div className="flex items-center justify-between px-4 pb-4 pt-2 border-t border-gray-200/50 dark:border-gray-700/50 mx-2">
                    <div className="flex gap-2">
                       <button
                        type="button"
                        onClick={startListening}
                        className={`p-2.5 rounded-xl transition-all duration-300 flex items-center gap-2 ${isListening ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 hover:bg-primary-100 hover:text-primary-600'}`}
                        title="تایپ صوتی"
                      >
                        {isListening ? <MicOff size={20} /> : <Mic size={20} />}
                        <span className="text-sm font-medium hidden sm:inline">{isListening ? 'در حال شنیدن...' : 'صوتی'}</span>
                      </button>

                      <button
                        type="button"
                        onClick={() => fileInputRef.current?.click()}
                        className={`p-2.5 rounded-xl transition-all duration-300 flex items-center gap-2 ${image ? 'bg-primary-100 text-primary-600' : 'bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300 hover:bg-primary-100 hover:text-primary-600'}`}
                        title="آپلود عکس"
                      >
                        <ImageIcon size={20} />
                        <span className="text-sm font-medium hidden sm:inline">تصویر</span>
                      </button>
                      <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
                    </div>

                    <button
                      type="submit"
                      disabled={loading || (!input && !image)}
                      className={`
                        px-8 py-3 rounded-xl font-bold text-lg flex items-center gap-2 transition-all transform hover:-translate-y-1 hover:shadow-lg
                        ${loading || (!input && !image)
                          ? 'bg-gray-300 dark:bg-gray-700 text-gray-500 cursor-not-allowed'
                          : 'bg-gradient-to-r from-primary-600 to-accent-600 text-white shadow-primary-500/30'
                        }
                      `}
                    >
                      {loading ? <Loader2 className="animate-spin" size={20} /> : <Send size={20} />}
                      <span>حل کن</span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
          
          <div className="text-center mt-4 text-gray-500 dark:text-gray-400 text-sm flex justify-center gap-6">
             <span className="flex items-center gap-1"><ClipboardPaste size={14}/> چسباندن تصویر فعال</span>
          </div>
        </div>

        {/* Error Alert */}
        {error && (
          <div className="max-w-4xl mx-auto mt-8 animate-in slide-in-from-top-2">
            <div className="bg-red-50 dark:bg-red-900/30 border-r-4 border-red-500 p-4 rounded-xl flex items-center gap-3">
              <AlertTriangle className="text-red-500 flex-shrink-0" />
              <p className="text-red-700 dark:text-red-200 font-medium">{error}</p>
            </div>
          </div>
        )}

        {/* Answer Section */}
        {response && (
          <div className="max-w-4xl mx-auto mt-16 animate-in slide-in-from-bottom-8 duration-700 relative z-10">
            <div className="absolute inset-0 bg-gradient-to-r from-primary-200 to-accent-200 blur-3xl opacity-40 -z-10"></div>
            
            <div className="bg-white dark:bg-gray-800 rounded-[2rem] shadow-2xl overflow-hidden relative border border-white/50 dark:border-gray-700">
              <div className="bg-gradient-to-r from-primary-100/50 to-accent-100/50 dark:from-primary-900/30 dark:to-accent-900/30 p-6 flex items-center gap-3 border-b border-gray-100 dark:border-gray-700">
                <div className="bg-green-100 dark:bg-green-900/50 p-2 rounded-full text-green-600 dark:text-green-400 shadow-inner">
                  <GraduationCap size={24} />
                </div>
                <h3 className="font-bold text-xl text-gray-800 dark:text-gray-200">پاسخ معلم:</h3>
              </div>
              
              <div className="p-8 md:p-12 bg-[url('https://www.transparenttextures.com/patterns/notebook.png')] dark:bg-none">
                <div className="prose dark:prose-invert prose-xl max-w-none text-gray-800 dark:text-gray-200 leading-loose" dir="rtl">
                  <div className="whitespace-pre-wrap font-medium">
                    {response}
                  </div>
                </div>
              </div>

              <div className="bg-gray-50 dark:bg-gray-900/50 p-4 flex justify-between items-center border-t border-gray-100 dark:border-gray-700 pt-4">
                 <div className="text-sm text-gray-500">مفید بود؟</div>
                 <button 
                   onClick={() => navigator.clipboard.writeText(response)}
                   className="text-primary-600 hover:bg-primary-100 dark:hover:bg-gray-800 px-4 py-2 rounded-lg text-sm font-bold transition-colors"
                 >
                   کپی متن
                 </button>
              </div>
            </div>
          </div>
        )}

        {/* Quick Features - Redesigned */}
        <div className="mt-24 grid grid-cols-1 md:grid-cols-3 gap-8 relative z-10">
          
          <Link to="/books" className="group relative bg-white/40 dark:bg-gray-800/40 backdrop-blur-xl p-1 rounded-[2.5rem] shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-3 border border-white/40 dark:border-white/10">
            <div className="bg-white dark:bg-gray-800/80 h-full rounded-[2.2rem] p-8 overflow-hidden relative">
                <div className="absolute -right-12 -top-12 w-48 h-48 bg-primary-100 dark:bg-primary-900/20 rounded-full blur-2xl group-hover:bg-primary-200 dark:group-hover:bg-primary-900/30 transition-colors"></div>
                
                <div className="relative z-10 flex flex-col h-full">
                    <div className="flex justify-between items-start mb-8">
                        <div className="w-16 h-16 bg-gradient-to-br from-primary-500 to-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-primary-500/30 group-hover:scale-110 transition-transform duration-500">
                          <BookOpen size={32} />
                        </div>
                        <div className="bg-gray-100 dark:bg-gray-700 rounded-full p-2 opacity-0 group-hover:opacity-100 transform translate-x-4 group-hover:translate-x-0 transition-all duration-300">
                            <ArrowLeft size={20} className="text-gray-600 dark:text-gray-300" />
                        </div>
                    </div>
                    
                    <h3 className="text-3xl font-bold text-gray-900 dark:text-white mb-3 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">کتابخانه</h3>
                    <p className="text-gray-500 dark:text-gray-400 leading-relaxed mb-4">دانلود رایگان کتاب‌های درسی و جزوات آموزشی برتر.</p>
                </div>
            </div>
          </Link>

          <Link to="/teachers" className="group relative bg-white/40 dark:bg-gray-800/40 backdrop-blur-xl p-1 rounded-[2.5rem] shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-3 border border-white/40 dark:border-white/10">
            <div className="bg-white dark:bg-gray-800/80 h-full rounded-[2.2rem] p-8 overflow-hidden relative">
                <div className="absolute -right-12 -top-12 w-48 h-48 bg-accent-100 dark:bg-accent-900/20 rounded-full blur-2xl group-hover:bg-accent-200 dark:group-hover:bg-accent-900/30 transition-colors"></div>
                
                <div className="relative z-10 flex flex-col h-full">
                    <div className="flex justify-between items-start mb-8">
                        <div className="w-16 h-16 bg-gradient-to-br from-accent-500 to-pink-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-accent-500/30 group-hover:scale-110 transition-transform duration-500">
                          <User size={32} />
                        </div>
                        <div className="bg-gray-100 dark:bg-gray-700 rounded-full p-2 opacity-0 group-hover:opacity-100 transform translate-x-4 group-hover:translate-x-0 transition-all duration-300">
                            <ArrowLeft size={20} className="text-gray-600 dark:text-gray-300" />
                        </div>
                    </div>
                    
                    <h3 className="text-3xl font-bold text-gray-900 dark:text-white mb-3 group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors">معلمین برتر</h3>
                    <p className="text-gray-500 dark:text-gray-400 leading-relaxed mb-4">ارتباط مستقیم با اساتید مجرب و دریافت مشاوره تخصصی.</p>
                </div>
            </div>
          </Link>

          <Link to="/videos" className="group relative bg-white/40 dark:bg-gray-800/40 backdrop-blur-xl p-1 rounded-[2.5rem] shadow-xl hover:shadow-2xl transition-all duration-500 hover:-translate-y-3 border border-white/40 dark:border-white/10">
            <div className="bg-white dark:bg-gray-800/80 h-full rounded-[2.2rem] p-8 overflow-hidden relative">
                <div className="absolute -right-12 -top-12 w-48 h-48 bg-blue-100 dark:bg-blue-900/20 rounded-full blur-2xl group-hover:bg-blue-200 dark:group-hover:bg-blue-900/30 transition-colors"></div>
                
                <div className="relative z-10 flex flex-col h-full">
                    <div className="flex justify-between items-start mb-8">
                        <div className="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-600 text-white rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform duration-500">
                          <PlayCircle size={32} />
                        </div>
                         <div className="bg-gray-100 dark:bg-gray-700 rounded-full p-2 opacity-0 group-hover:opacity-100 transform translate-x-4 group-hover:translate-x-0 transition-all duration-300">
                            <ArrowLeft size={20} className="text-gray-600 dark:text-gray-300" />
                        </div>
                    </div>
                    
                    <h3 className="text-3xl font-bold text-gray-900 dark:text-white mb-3 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">ویدیو کلوپ</h3>
                    <p className="text-gray-500 dark:text-gray-400 leading-relaxed mb-4">دسترسی به آرشیو فیلم‌های آموزشی و نکات تستی.</p>
                </div>
            </div>
          </Link>
        </div>

      </div>
    </div>
  );
};

--- frontend/src/pages/Paradox.tsx ---
import React, { useState } from 'react';
import { useAppContext } from '../AppContext';
import { HelpCircle, ChevronDown, ChevronUp } from 'lucide-react';

export const Paradox: React.FC = () => {
  const { paradoxes } = useAppContext();
  const [openId, setOpenId] = useState<string | null>(null);

  return (
    <div className="max-w-4xl mx-auto px-4 py-8">
      <div className="text-center mb-12">
        <h1 className="text-4xl font-bold text-gray-900 dark:text-white mb-4">
          <span className="text-accent-500">پارادوکس‌های</span> شگفت‌انگیز
        </h1>
        <p className="text-lg text-gray-600 dark:text-gray-300">
          مسائلی که ذهن بزرگترین ریاضیدانان تاریخ را به چالش کشیده‌اند.
        </p>
      </div>

      <div className="space-y-6">
        {paradoxes.map((item) => (
          <div 
            key={item.id} 
            className="bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden transition-all hover:shadow-md"
          >
            <button
              onClick={() => setOpenId(openId === item.id ? null : item.id)}
              className="w-full flex items-center justify-between p-6 text-right focus:outline-none group"
            >
              <div className="flex items-center gap-4">
                <div className="p-3 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-xl group-hover:scale-110 transition-transform">
                  <HelpCircle size={24} />
                </div>
                <div>
                  <h3 className="text-xl font-bold text-gray-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
                    {item.title}
                  </h3>
                  <p className="text-sm text-gray-500 dark:text-gray-400 mt-1 text-right">
                    {item.summary}
                  </p>
                </div>
              </div>
              <div className="text-gray-400">
                {openId === item.id ? <ChevronUp /> : <ChevronDown />}
              </div>
            </button>
            
            {openId === item.id && (
              <div className="px-6 pb-8 pt-0 animate-in slide-in-from-top-2 duration-200">
                 <div className="h-px w-full bg-gray-100 dark:bg-gray-700 mb-6"></div>
                 <div className="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 leading-loose text-justify whitespace-pre-wrap">
                   {item.content}
                 </div>
              </div>
            )}
          </div>
        ))}
        {paradoxes.length === 0 && (
            <div className="text-center text-gray-500 py-10">موردی یافت نشد.</div>
        )}
      </div>
    </div>
  );
};

--- frontend/src/pages/Teachers.tsx ---
import React from 'react';
import { useAppContext } from '../AppContext';
import { Mail, Phone, Briefcase, User } from 'lucide-react';

export const Teachers: React.FC = () => {
  const { teachers } = useAppContext();

  return (
    <div className="max-w-7xl mx-auto px-4 py-12">
      <h1 className="text-4xl font-black text-center text-gray-900 dark:text-white mb-12">
        <span className="bg-clip-text text-transparent bg-gradient-to-r from-primary-600 to-accent-600">
          اساتید برتر
        </span> ریاضی‌یار
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 justify-items-center">
        {teachers.map(teacher => (
          <div key={teacher.id} className="group w-full max-w-sm h-[420px] [perspective:1000px] cursor-pointer">
            <div className="relative w-full h-full transition-all duration-700 [transform-style:preserve-3d] group-hover:[transform:rotateY(180deg)] shadow-xl rounded-3xl">
              
              {/* FRONT SIDE */}
              <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] rounded-3xl overflow-hidden bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700">
                <div className="h-full flex flex-col">
                  <div className="flex-1 relative">
                    <img 
                      src={teacher.imageUrl} 
                      alt={teacher.name} 
                      className="w-full h-full object-cover"
                    />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>
                    <div className="absolute bottom-0 left-0 right-0 p-6 text-white text-center">
                      <h2 className="text-3xl font-bold mb-2 drop-shadow-md">{teacher.name}</h2>
                      <div className="w-16 h-1 bg-accent-500 mx-auto rounded-full"></div>
                    </div>
                  </div>
                  <div className="bg-gray-50 dark:bg-gray-900 p-4 text-center">
                    <span className="text-sm text-gray-500 dark:text-gray-400 font-medium animate-pulse">
                      برای مشاهده جزئیات نگه دارید
                    </span>
                  </div>
                </div>
              </div>

              {/* BACK SIDE */}
              <div className="absolute inset-0 w-full h-full [backface-visibility:hidden] [transform:rotateY(180deg)] rounded-3xl overflow-hidden bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 text-white p-8 flex flex-col justify-center text-center shadow-2xl border border-white/20 relative">
                
                {/* Decorative Pattern */}
                <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(circle, #fff 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                
                <div className="relative z-10">
                    <div className="w-24 h-24 mx-auto mb-6 rounded-full border-4 border-white/30 overflow-hidden shadow-lg p-1 bg-white/10 backdrop-blur-sm">
                       <img src={teacher.imageUrl} alt={teacher.name} className="w-full h-full object-cover rounded-full" />
                    </div>
                    
                    <h3 className="text-2xl font-bold mb-4 text-white drop-shadow-sm">{teacher.name}</h3>
                    
                    <div className="flex-1 overflow-y-auto mb-4 space-y-4 custom-scrollbar">
                       <p className="text-white/90 text-sm leading-relaxed px-2 font-medium">
                         {teacher.bio}
                       </p>
                       
                       <div className="bg-white/10 rounded-xl p-3 backdrop-blur-md border border-white/10">
                          <div className="flex items-center justify-center gap-2 text-pink-200 mb-1">
                            <Briefcase size={16} />
                            <span className="font-bold text-sm">سابقه کاری</span>
                          </div>
                          <p className="text-xs text-white font-medium">{teacher.experience}</p>
                       </div>
                    </div>

                    <div className="space-y-3 pt-4 border-t border-white/20">
                       <a href={`tel:${teacher.phone}`} className="flex items-center justify-center gap-2 bg-white/10 hover:bg-white/20 py-2 rounded-lg transition-colors text-sm font-bold backdrop-blur-sm border border-white/10">
                         <Phone size={16} />
                         {teacher.phone}
                       </a>
                       <a href={`mailto:${teacher.email}`} className="flex items-center justify-center gap-2 bg-white text-purple-700 hover:bg-gray-100 py-2 rounded-lg transition-colors text-sm font-bold shadow-lg">
                         <Mail size={16} />
                         ارسال ایمیل
                       </a>
                    </div>
                </div>
              </div>
              
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

--- frontend/src/pages/Videos.tsx ---
import React, { useState } from 'react';
import { useAppContext } from '../AppContext';
import { Play, X } from 'lucide-react';
import { Video } from '../types';

export const Videos: React.FC = () => {
  const { videos } = useAppContext();
  const [selectedVideo, setSelectedVideo] = useState<Video | null>(null);

  return (
    <div className="max-w-7xl mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-8 border-r-4 border-rose-500 pr-4">
        ویدیو کلوپ ریاضی
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {videos.map(video => (
          <div 
            key={video.id} 
            onClick={() => setSelectedVideo(video)}
            className="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm hover:shadow-xl transition-all group cursor-pointer block"
          >
            <div className="relative aspect-video bg-gray-900">
              <img src={video.thumbnailUrl} alt={video.title} className="w-full h-full object-cover opacity-80 group-hover:opacity-60 transition-opacity" />
              <div className="absolute inset-0 flex items-center justify-center">
                <div className="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center group-hover:scale-110 transition-transform">
                  <Play className="text-white ml-1" fill="currentColor" size={20} />
                </div>
              </div>
              <div className="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                {video.duration}
              </div>
            </div>
            
            <div className="p-4">
              <div className="flex justify-between items-start mb-2">
                <span className="text-xs font-bold text-rose-500 bg-rose-50 dark:bg-rose-900/20 px-2 py-1 rounded">
                  پایه {video.category}
                </span>
              </div>
              <h3 className="font-bold text-lg text-gray-900 dark:text-white mb-1 line-clamp-1 group-hover:text-rose-500 transition-colors">{video.title}</h3>
              <p className="text-sm text-gray-500 dark:text-gray-400">مدرس: {video.tutor}</p>
            </div>
          </div>
        ))}
      </div>

      {/* Video Player Modal */}
      {selectedVideo && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="relative w-full max-w-4xl bg-black rounded-2xl overflow-hidden shadow-2xl">
            <div className="absolute top-4 right-4 z-10">
              <button 
                onClick={() => setSelectedVideo(null)}
                className="bg-black/50 hover:bg-red-600 text-white p-2 rounded-full transition-colors backdrop-blur-md"
              >
                <X size={24} />
              </button>
            </div>
            
            <div className="aspect-video w-full">
              {selectedVideo.videoUrl ? (
                 <div 
                   className="w-full h-full [&>iframe]:w-full [&>iframe]:h-full"
                   dangerouslySetInnerHTML={{ __html: selectedVideo.videoUrl }}
                 />
              ) : (
                <div className="w-full h-full flex items-center justify-center text-white">
                  لینک ویدیو موجود نیست
                </div>
              )}
            </div>

            <div className="p-4 bg-white dark:bg-gray-800">
               <h3 className="text-xl font-bold text-gray-900 dark:text-white">{selectedVideo.title}</h3>
               <div className="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                 <span>مدرس: {selectedVideo.tutor}</span>
                 <span>•</span>
                 <span>پایه {selectedVideo.category}</span>
               </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

--- frontend/src/services/api.ts ---
import { Book, Teacher, Video, Paradox, Creator, Settings } from '../types';

// مهم: آدرس بک‌اند را از متغیرهای محیطی می‌خوانیم
const API_URL = import.meta.env.VITE_API_BASE_URL;

const request = async (endpoint: string, options?: RequestInit) => {
  try {
    // اگر آدرس بک‌اند تعریف نشده بود، خطا بده
    if (!API_URL) {
      throw new Error("VITE_API_BASE_URL is not defined. Please check your environment variables in Vercel.");
    }

    const response = await fetch(`${API_URL}${endpoint}`, {
      headers: {
        'Content-Type': 'application/json',
      },
      ...options,
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ message: response.statusText }));
      throw new Error(errorData.message || `API Error: ${response.status}`);
    }
    
    // اگر پاسخ محتوایی نداشت (مثل status 204)، یک آبجکت خالی برگردان
    if (response.status === 204) {
        return {};
    }

    return await response.json();
  } catch (error) {
    console.error('API Request Failed:', error);
    throw error;
  }
};

export const api = {
  getBooks: () => request('/books'),
  saveBooks: (data: Book[]) => request('/books', { method: 'POST', body: JSON.stringify(data) }),
  getTeachers: () => request('/teachers'),
  saveTeachers: (data: Teacher[]) => request('/teachers', { method: 'POST', body: JSON.stringify(data) }),
  getVideos: () => request('/videos'),
  saveVideos: (data: Video[]) => request('/videos', { method: 'POST', body: JSON.stringify(data) }),
  getParadoxes: () => request('/paradoxes'),
  saveParadoxes: (data: Paradox[]) => request('/paradoxes', { method: 'POST', body: JSON.stringify(data) }),
  getCreators: () => request('/creators'),
  saveCreators: (data: Creator[]) => request('/creators', { method: 'POST', body: JSON.stringify(data) }),
  getSettings: () => request('/settings'),
  saveSettings: (data: Settings) => request('/settings', { method: 'POST', body: JSON.stringify(data) }),
};

--- frontend/src/services/geminiService.ts ---
const API_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:4000/api';

export const validateApiKey = async (apiKey: string): Promise<boolean> => {
  return apiKey && apiKey.length > 10;
};

export const solveMathProblem = async (
  promptText: string,
  imageBase64: string | undefined,
  imageMimeType: string = 'image/jpeg',
  apiKey: string
): Promise<string> => {

  try {
    // استفاده از بک‌تیک (`) بسیار مهم است
    const response = await fetch(`${API_URL}/ai/solve`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        prompt: promptText,
        image: imageBase64,
        mimeType: imageMimeType
      }),
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || 'خطا در دریافت پاسخ از سرور');
    }

    return data.answer;

  } catch (error: any) {
    console.error("Connection Error:", error);
    throw new Error("مشکلی در ارتباط با سرور پیش آمد.");
  }
};

--- frontend/src/types.ts ---
export interface Book {
  id: string;
  title: string;
  author: string;
  description: string;
  subject: string;
  imageUrl: string;
  downloadUrl: string;
  rating: number;
}

export interface Teacher {
  id: string;
  name: string;
  bio: string; // توضیحات
  experience: string; // سابقه کاری
  imageUrl: string;
  phone: string;
  email: string;
}

export interface Video {
  id: string;
  title: string;
  tutor: string;
  thumbnailUrl: string;
  duration: string;
  category: string;
  videoUrl?: string;
}

export interface Paradox {
  id: string;
  title: string;
  summary: string;
  content: string;
}

export interface Creator {
  id: string;
  name: string;
  role: string; // پایه / نقش
  bio: string;
  imageUrl: string;
}

export interface Settings {
  appName: string;
  appLogoUrl: string;
  adminEmail: string;
  eitaaLink: string;
  rubikaLink: string;
  address: string;
  phone: string;
  copyrightText: string;
  apiKey: string;
}

export interface ChatMessage {
  role: 'user' | 'model';
  text: string;
  isError?: boolean;
}

export interface ThemeSettings {
  darkMode: boolean;
  primaryColor: string;
}

export interface AppContextType {
  books: Book[];
  teachers: Teacher[];
  videos: Video[];
  paradoxes: Paradox[];
  creators: Creator[];
  settings: Settings;
  theme: ThemeSettings;
  isAuthenticated: boolean;
  login: () => void;
  logout: () => void;
  toggleTheme: () => void;
  updateData: (type: 'books' | 'teachers' | 'videos' | 'paradoxes' | 'creators', data: any[]) => void;
  updateSettings: (newSettings: Settings) => void;
}

--- frontend/src/vite-env.d.ts ---
/// <reference types="vite/client" />

--- frontend/tailwind.config.js ---
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}", // این آدرس باید دقیقاً به پوشه src اشاره کند
  ],
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: {
        sans: ['Vazirmatn', 'ui-sans-serif', 'system-ui', 'sans-serif'],
      },
      colors: {
        primary: {
          50: '#f5f3ff',
          100: '#ede9fe',
          200: '#ddd6fe',
          300: '#c4b5fd',
          400: '#a78bfa',
          500: '#8b5cf6',
          600: '#7c3aed',
          700: '#6d28d9',
          800: '#5b21b6',
          900: '#4c1d95',
        },
        accent: {
          50: '#fdf2f8',
          100: '#fce7f3',
          200: '#fbcfe8',
          300: '#f9a8d4',
          400: '#f472b6',
          500: '#ec4899',
          600: '#db2777',
          700: '#be185d',
          800: '#9d174d',
          900: '#831843',
        }
      },
      animation: {
        'float': 'float 6s ease-in-out infinite',
        'pulse-glow': 'pulse-glow 3s infinite',
        'wander-1': 'wander1 20s infinite alternate ease-in-out',
        'wander-2': 'wander2 25s infinite alternate-reverse ease-in-out',
        'wander-3': 'wander3 30s infinite linear',
      },
      keyframes: {
        float: {
          '0%, 100%': { transform: 'translateY(0)' },
          '50%': { transform: 'translateY(-20px)' },
        },
        'pulse-glow': {
          '0%, 100%': { opacity: '1', filter: 'drop-shadow(0 0 10px rgba(236, 72, 153, 0.5))' },
          '50%': { opacity: '0.8', filter: 'drop-shadow(0 0 20px rgba(139, 92, 246, 0.8))' },
        },
        wander1: {
          '0%': { transform: 'translate(0, 0) rotate(0deg) scale(1)' },
          '33%': { transform: 'translate(100px, -50px) rotate(10deg) scale(1.1)' },
          '66%': { transform: 'translate(-50px, 100px) rotate(-5deg) scale(0.9)' },
          '100%': { transform: 'translate(-20px, -20px) rotate(5deg) scale(1)' },
        },
        wander2: {
          '0%': { transform: 'translate(0, 0) scale(1)' },
          '50%': { transform: 'translate(-80px, -40px) scale(1.2)' },
          '100%': { transform: 'translate(50px, 60px) scale(0.9)' },
        },
        wander3: {
          '0%': { transform: 'rotate(0deg) translate(0,0)' },
          '50%': { transform: 'rotate(180deg) translate(50px, 50px)' },
          '100%': { transform: 'rotate(360deg) translate(0,0)' },
        }
      }
    },
  },
  plugins: [],
}

--- frontend/tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "baseUrl": ".",
    "paths": {
      "@/*": [
        "./src/*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  },
  "include": ["src"]
}

--- frontend/vite.config.ts ---
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig(({ mode }) => {
    // اصلاح مسیر خواندن env
    const env = loadEnv(mode, process.cwd(), '');
    
    return {
      plugins: [react()],
      resolve: {
        alias: {
          // اصلاح مهم: @ باید به پوشه src اشاره کند
          '@': path.resolve(__dirname, './src'),
        },
      },
      // تعریف متغیرها برای استفاده در فرانت (اختیاری ولی مفید)
      define: {
        'process.env': env
      }
    };
});